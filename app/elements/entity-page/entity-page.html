<!--
Copyright 2018 Next Century Corporation

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/aggregation-query-and-display/aggregation-query-and-display.html">
<link rel="import" href="../../bower_components/auto-paginated-image-gallery/auto-paginated-image-gallery.html">
<link rel="import" href="../../bower_components/build-and-run-query/build-and-run-query.html">
<link rel="import" href="../../bower_components/dig-logger/dig-logger.html">
<link rel="import" href="../../bower_components/elastic-client/elastic-client.html">
<link rel="import" href="../../bower_components/elastic-client-aggregation-builder/elastic-client-aggregation-builder.html">
<link rel="import" href="../../bower_components/elastic-error/elastic-error.html">
<link rel="import" href="../../bower_components/export-button/export-button.html">
<link rel="import" href="../../bower_components/filters-builder/filters-builder.html">
<link rel="import" href="../../bower_components/icon-button/icon-button.html">
<link rel="import" href="../../bower_components/image-query-and-display/image-query-and-display.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-dropdown/iron-dropdown.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/json-combine/json-combine.html">
<link rel="import" href="../../bower_components/loading-spinner/loading-spinner.html">
<link rel="import" href="../../bower_components/lodash-import/lodash.html">
<link rel="import" href="../../bower_components/log-creator/log-creator.html">
<link rel="import" href="../../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../../bower_components/profile-manager/profile-manager.html">
<link rel="import" href="../../bower_components/query-builder/query-builder.html">
<link rel="import" href="../../bower_components/result-list/result-list.html">
<link rel="import" href="../../bower_components/save-case-dialog/save-case-dialog.html">
<link rel="import" href="../../bower_components/selected-facets-display/selected-facets-display.html">
<link rel="import" href="../../bower_components/sparkline-list/sparkline-list.html">
<link rel="import" href="../../bower_components/state-manager/state-manager.html">
<link rel="import" href="../../bower_components/stylized-icon/stylized-icon.html">
<link rel="import" href="../../bower_components/tag-manager/tag-manager.html">
<link rel="import" href="../../bower_components/terms-transformer/terms-transformer.html">
<link rel="import" href="../../bower_components/user-settings-dialog/user-settings-button.html">
<link rel="import" href="../../bower_components/user-settings-dialog/user-settings-dialog.html">
<link rel="import" href="../../bower_components/zoomable-bar-chart/zoomable-bar-chart.html">
<link rel="import" href="../../elements/behaviors.html">
<link rel="import" href="../../elements/copy-button/copy-button.html">
<link rel="import" href="../../elements/dual-column/dual-column.html">
<link rel="import" href="../../elements/section-wrapper/section-wrapper.html">
<link rel="import" href="../../elements/transform-functions/transform-functions.html">
<link rel="import" href="../../styles/entity-page-styles.html">
<link rel="import" href="../../styles/page-styles.html">

<dom-module id="entity-page">
  <template>
    <style include="iron-flex iron-flex-reverse iron-flex-alignment iron-flex-factors iron-positioning"></style>
    <style include="page-styles"></style>
    <style include="entity-page-styles"></style>

    <style>
      :host {
        display: block;
        @apply --layout-fullbleed;
      }

      section-wrapper[slot="top"] {
        height: 100%;
        --section-wrapper-height: none;
        --section-wrapper-margin: 0;
        --section-wrapper-min-height: 100%;
      }

      copy-button,
      .scroll-button {
        margin: 0 5px;
      }

      .bottom-margin {
        margin-bottom: 10px;
      }

      aggregation-query-and-display,
      image-query-and-display,
      sparkline-list {
        /* Use padding here because margin hides the Show More button shadow. */
        padding-bottom: 10px;
      }

      aggregation-query-and-display {
        --aggregation-query-and-display-max-height: none;
      }

      image-query-and-display {
        --image-query-and-display-max-height: none;
      }

      sparkline-list {
        --sparkline-list-max-height: none;
      }

      image-query-and-display {
        --image-query-and-display-max-height: none;
      }

      status-text {
        margin-bottom: 10px;
        margin-right: 5px;
      }

      auto-paginated-image-gallery {
        --auto-paginated-image-gallery-hovering-color: yellow;
        --auto-paginated-image-gallery-selected-color: var(--primary-background-color);
        --auto-paginated-image-gallery-max-height: none;
        --auto-paginated-image-gallery-show-more-button: {
          margin-top: 10px;
        };
      }

      .hide {
        display: none;
      }
    </style>

    <iron-ajax
      auto
      handle-as="json"
      url="/dig-ui/config"
      last-response="{{serverConfig}}">
    </iron-ajax>

    <template is="dom-if" if="[[serverConfig.overrideConfig]]">
      <transform-functions
        client-config="[[serverConfig.overrideConfig]]"
        domain="[[domain]]"
        server-config="[[serverConfig]]"
        es-config="{{esConfig}}"
        transforms="{{transforms}}">
      </transform-functions>

      <json-combine
        data-in1="[[serverConfig.overrideConfig]]"
        data-in2="{}"
        data-out="{{clientConfigFields}}"
        combine-function="[[transforms.config.fields]]">
      </json-combine>
    </template>

    <template is="dom-if" if="[[!serverConfig.overrideConfig]]">
      <iron-ajax
        auto="[[exists(configHeader)]]"
        handle-as="json"
        headers="[[configHeader]]"
        url="[[concat(serverConfig.configEndpoint, domain)]]"
        with-credentials
        loading="{{clientConfigLoading}}"
        last-error="{{clientConfigError}}"
        last-response="{{clientConfig}}">
      </iron-ajax>

      <transform-functions
        client-config="[[clientConfig]]"
        domain="[[domain]]"
        server-config="[[serverConfig]]"
        es-config="{{esConfig}}"
        transforms="{{transforms}}">
      </transform-functions>

      <json-combine
        data-in1="[[clientConfig]]"
        data-in2="{}"
        data-out="{{clientConfigFields}}"
        combine-function="[[transforms.config.fields]]">
      </json-combine>
    </template>

    <json-combine
      data-in1="[[clientConfigFields]]"
      data-in2="{}"
      data-out="{{searchFields}}"
      combine-function="[[transforms.config.searchFields]]">
    </json-combine>

    <json-combine
      data-in1="[[searchFields]]"
      data-in2="{}"
      data-out="{{searchFieldsCollection}}"
      combine-function="[[transforms.config.searchFieldsCollection]]">
    </json-combine>

    <json-combine
      data-in1="[[searchFields]]"
      data-in2="{}"
      data-out="{{aggregationFields}}"
      combine-function="[[transforms.config.aggregationFields]]">
    </json-combine>

    <json-combine
      data-in1="[[searchFields]]"
      data-in2="{}"
      data-out="{{colorMap}}"
      combine-function="[[transforms.config.colorMap]]">
    </json-combine>

    <json-combine
      data-in1="[[searchFields]]"
      data-in2="{}"
      data-out="{{dateMenu}}"
      combine-function="[[transforms.config.dateMenu]]">
    </json-combine>

    <json-combine
      data-in1="[[searchFields]]"
      data-in2="{}"
      data-out="{{filterCollection}}"
      combine-function="[[transforms.config.filterCollection]]">
    </json-combine>

    <json-combine
      data-in1="[[searchFields]]"
      data-in2="{}"
      data-out="{{buildersConfig}}"
      combine-function="[[transforms.config.filterCollectionBuildersConfig]]">
    </json-combine>

    <json-combine
      data-in1="[[searchFields]]"
      data-in2="[[parameters.type]]"
      data-out="{{pageConfig}}"
      combine-function="[[transforms.config.pageConfig]]">
    </json-combine>

    <json-combine
      data-in1="[[parameters.id]]"
      data-in2="[[pageConfig.type]]"
      data-out="{{pageId}}"
      combine-function="[[transforms.config.formatId]]">
    </json-combine>

    <json-combine
      data-in1="[[pageId]]"
      data-in2="[[pageConfig.type]]"
      data-out="{{pageName}}"
      combine-function="[[transforms.config.formatName]]">
    </json-combine>

    <json-combine
      data-in1="[[searchFields]]"
      data-in2="{}"
      data-out="{{entityFilters}}"
      combine-function="[[transforms.config.entityFilters]]">
    </json-combine>

    <elastic-client
      config="[[serverConfig.esHost]]"
      client="{{esClient}}">
    </elastic-client>

     <!-- Logger for Filter Terms -->
    <dig-logger
      es-client="[[esClient]]"
      es-index="[[serverConfig.logIndexName]]"
      es-type="[[serverConfig.logIndexType]]"
      type="Entity-Filter"
      data="[[logMessage]]"
      username="[[serverConfig.username]]">
    </dig-logger>

     <!-- Logger for Pagination -->
    <dig-logger
      es-client="[[esClient]]"
      es-index="[[serverConfig.logIndexName]]"
      es-type="[[serverConfig.logIndexType]]"
      type="Entity-ResultPage"
      data="[[searchPage]]"
      username="[[serverConfig.username]]">
    </dig-logger>

    <!-- Logger for Page View -->
    <dig-logger log-page-view
      es-client="[[esClient]]"
      es-index="[[serverConfig.logIndexName]]"
      es-type="[[serverConfig.logIndexType]]"
      type="Entity-Open"
      data="[[parameters.state]]"
      username="[[serverConfig.username]]"
      logger="{{logger}}">
    </dig-logger>

    <log-creator
      object="{{filterCollection}}"
      log-message="{{logMessage}}">
    </log-creator>

    <profile-manager
      build-state-data-function="[[transforms.config.searchState]]"
      client="[[esClient]]"
      function-config="[[searchFields]]"
      index-name="[[serverConfig.profileIndexName]]"
      index-type="[[serverConfig.profileIndexType]]"
      username="[[serverConfig.username]]"
      blur-images="{{blurImages}}"
      cases="{{cases}}"
      email-address="{{emailAddress}}"
      notifications="{{notifications}}"
      notification-interval="{{notificationInterval}}"
      profile-manager="{{profileManager}}"
      user-id="{{userId}}"
      user-loading="{{userLoading}}">
    </profile-manager>

    <build-and-run-query
      query="[[thisPageQuery]]"
      client="[[esClient]]"
      index-name="[[esConfig.esIndex]]"
      index-types="[[esConfig.esType]]"
      aggregations="[]"
      filters="[[filterList]]"
      page="{{searchPage}}"
      page-size="10"
      properties-ready="{{processRequest}}"
      sort-field="[[dateMenu.selected]]"
      source-include="[[getSourceIncludes(serverConfig.sendSearchesDirectlyToES, esConfig.timestamp, esConfig.uid)]]"
      transform-config="[[searchFields]]"
      transform-function="[[transforms.entity.results]]"
      error="{{searchError}}"
      loading="{{searchLoading}}"
      results="{{searchResults}}"
      total="{{searchTotal}}">
    </build-and-run-query>

    <query-builder
      type="term"
      callback="[[builderCallbacks]]"
      config="[[buildersConfig]]"
      data="[[filterCollection]]"
      query="{{thisPageFilterQuery}}">
    </query-builder>

    <elastic-client-query-builder
      type="term"
      fields="[[pageConfig.field]]"
      values="[[pageId]]"
      ejs-query="{{thisEntityQuery}}">
    </elastic-client-query-builder>

    <elastic-client-query-builder
      type="bool"
      bool-function="must"
      ejs-bool-queries="[[buildArray(thisEntityQuery, thisPageFilterQuery)]]"
      ejs-query="{{thisPageQuery}}">
    </elastic-client-query-builder>

    <filters-builder
      callback="[[builderCallbacks]]"
      config="[[buildersConfig]]"
      data="[[filterCollection]]"
      filters="{{filterList}}">
    </filters-builder>

    <tag-manager
      id="tagManager"
      auth-username="[[serverConfig.configUsername]]"
      auth-password="[[serverConfig.configPassword]]"
      entity-endpoint="[[serverConfig.tagsEntityEndpoint]]"
      extraction-endpoint="[[serverConfig.tagsExtractionEndpoint]]"
      list-endpoint="[[serverConfig.tagsListEndpoint]]"
      project="[[domain]]"
      tag-manager="{{tagManager}}">
    </tag-manager>

    <!-- Must wait for the filterCollection to be defined. -->
    <template is="dom-if" if="[[filterCollection]]">
      <state-manager id="stateManager"
        build-popup-data-function="[[transforms.config.filterTerms]]"
        build-state-data-function="[[transforms.config.filterState]]"
        client="[[esClient]]"
        function-config="[[searchFields]]"
        header-type="Filter"
        state-index="[[serverConfig.stateIndexName]]"
        state-type="[[serverConfig.stateIndexType]]"
        state-id="[[parameters.state]]"
        collection="{{filterCollection}}"
        process-request="{{processRequest}}"
        state-history="{{stateHistory}}"
        has-history="{{hasHistory}}">
      </state-manager>
    </template>

    <save-case-dialog
      id="saveDialog"
      cases="[[cases]]"
      entity-field="[[pageConfig.field]]"
      entity-id="[[pageId]]"
      entity-name="[[pageName]]"
      entity-pretty-type="[[pageConfig.title]]"
      entity-type="[[parameters.type]]"
      profile-manager="[[profileManager]]"
      user-id="[[userId]]">
    </save-case-dialog>

    <iron-ajax
      id="imageSimilaritySearch"
      content-type="application/x-www-form-urlencoded"
      handle-as="json"
      loading="{{imageSimilaritySearchLoading}}"
      method="POST"
      params="{}"
      with-credentials
      on-error="handleImageSimilaritySearchResults"
      on-response="handleImageSimilaritySearchResults">
    </iron-ajax>

    <iron-ajax
      id="imageFaceSearch"
      content-type="application/x-www-form-urlencoded"
      handle-as="json"
      loading="{{imageFaceSearchLoading}}"
      method="POST"
      params="{}"
      with-credentials
      on-error="handleImageFaceSearchResults"
      on-response="handleImageFaceSearchResults">
    </iron-ajax>

    <template is="dom-if" if="[[serverConfig.username]]">
      <user-settings-dialog
        button-callbacks="{{userSettingsDialogCallbacks}}"
        enable-email-address
        build-popup-data-function="[[transforms.config.searchTerms]]"
        build-state-data-function="[[transforms.config.searchState]]"
        data-config="[[searchFieldsCollection]]"
        function-config="[[searchFields]]"
        profile-manager="[[profileManager]]"
        reset-dates-data-function="[[createResetDatesFunction(searchFields)]]"
        result-link-function="[[transforms.config.resultLink]]"
        user-id="[[userId]]"
        user-loading="[[userLoading]]"
        username="[[serverConfig.username]]"
        blur-images="{{blurImages}}"
        cases="{{cases}}"
        email-address="{{emailAddress}}"
        notifications="{{notifications}}"
        notification-date="{{notificationDate}}"
        notification-interval="{{notificationInterval}}"
        process-request="{{processRequest}}">
      </user-settings-dialog>
    </template>

    <div class="page-head">
      <a id="logoLink" href="[[serverConfig.pathPrefix]]" target="_blank" title="Open a DIG Search Page in a New Tab">
        <img id="logo" src="/dig-ui/dig-logo.png" alt="">
      </a>

      <div class="page-data">
        <template is="dom-if" if="[[pageConfig]]">
          <stylized-icon bigger class="page-icon" icon="[[pageConfig.icon]]" style-class="[[pageConfig.styleClass]]"></stylized-icon>

          <div class="page-name">[[pageConfig.title]]:</div>

          <template is="dom-if" if="[[!pageConfig.isImage]]">
            <div class="page-name">[[pageName]]</div>
          </template>

          <template is="dom-if" if="[[pageConfig.isImage]]">
            <json-combine
              data-in1="[[pageId]]"
              data-in2="[[esConfig]]"
              data-out="{{imageSrc}}"
              combine-function="[[transforms.config.imageSrc]]">
            </json-combine>

            <a class="page-link" href="[[imageSrc]]" target="_blank" title="Open Image">
              <iron-image class$="small-blur [[findNoBlurStyleClass(blurImages)]]" src="[[imageSrc]]"></iron-image>
            </a>
          </template>
        </template>
      </div>

      <template is="dom-if" if="[[serverConfig.username]]">
        <user-settings-button notifications="[[notifications]]" open-callback="[[userSettingsDialogCallbacks.openSettingsDialog]]"></user-settings-button>
      </template>

      <icon-button active="[[menuOpened]]" bigger id="menuButton" icon="fa:bars" slot="dropdown-trigger" title-tooltip="More Options" on-tap="toggleMenu"></icon-button>

      <iron-dropdown id="menuDropdown" horizontal-align="right" vertical-align="top" vertical-offset="50" opened="{{menuOpened}}">
        <div slot="dropdown-content">
          <template is="dom-if" if="[[serverConfig.username]]">
            <paper-icon-item disabled="[[!pageConfig]]" title="Save This [[pageConfig.title]] to Case..." on-tap="openSaveDialog">
              <iron-icon slot="item-icon" icon="fa:floppy-o" item-icon></iron-icon>
              Save This [[pageConfig.title]] to Case...
            </paper-icon-item>
          </template>

          <paper-icon-item disabled="[[!hasHistory]]" disabled="[[!pageConfig]]" title="View This Page's Filter History" on-tap="openStateHistoryDialog">
            <iron-icon slot="item-icon" icon="fa:history" item-icon></iron-icon>
            View This Page's Filter History
          </paper-icon-item>

          <template is="dom-if" if="[[serverConfig.tagsListEndpoint]]">
            <paper-icon-item disabled="[[!pageConfig]]" title="View DIG Data Training Options" on-tap="openTagsDialog">
              <iron-icon slot="item-icon" icon="fa:check-circle" item-icon></iron-icon>
              View DIG Data Training Options
            </paper-icon-item>
          </template>

          <paper-icon-item title="Open a DIG Search Page in a New Tab" on-tap="openNewTab">
            <iron-icon slot="item-icon" icon="fa:external-link-square" item-icon></iron-icon>
            Open a DIG Search Page in a New Tab
          </paper-icon-item>

          <paper-icon-item title="Open DIG Help Page" on-tap="openHelpPage">
            <iron-icon slot="item-icon" icon="fa:question-circle" item-icon></iron-icon>
            Open the DIG Help Page
          </paper-icon-item>

          <paper-icon-item title$="Contact Us ([[serverConfig.supportEmail]])" on-tap="sendSupportEmail">
            <iron-icon slot="item-icon" icon="fa:envelope" item-icon></iron-icon>
            Contact Us
          </paper-icon-item>
        </div>
      </iron-dropdown>
    </div>

    <template is="dom-if" if="[[!pageConfig]]">
      <div class="layout horizontal center-justified flex">
        <loading-spinner show type="Page"></loading-spinner>
      </div>
    </template>

    <template is="dom-if" if="[[pageConfig]]">
      <div class="page-body">
        <div class="page-column">
          <dual-column>
            <template is="dom-repeat" items="[[aggregationFields]]">
              <section-wrapper slot="top"
                class$="[[findShowDataStyleClass(item.showData)]]"
                error="[[item.aggregatedDataError]]"
                icon="[[item.entity.icon]]"
                loading="[[item.aggregatedDataLoading]]"
                no-data="[[!item.aggregatedDataResults.length]]"
                section-title="[[item.sectionTitle]]"
                style-class="[[item.entity.styleClass]]"
                show-load-icon>

                <json-combine
                  data-in1="[[item.aggregatedDataResults.length]]"
                  data-in2="[[createSectionTitleConfig(pageConfig, item.entity, item.aggregatedDataError, item.aggregatedDataLoading, item.aggregatedSubset)]]"
                  data-out="{{item.sectionTitle}}"
                  combine-function="[[createSectionTitle]]">
                </json-combine>

                <template is="dom-if" if="[[item.loadData]]">
                  <elastic-client-aggregation-builder
                    name="[[item.entity.key]]"
                    type="terms"
                    count="0"
                    order="_term"
                    direction="asc"
                    field="[[item.entity.field]]"
                    filters="[]"
                    ejs-aggregation="{{item.entityAggregation}}">
                  </elastic-client-aggregation-builder>

                  <template is="dom-if" if="[[item.entityAggregation]]">
                    <elastic-client-aggregation-builder
                      name="[[getDateProperty(item.dateCollection, item.dateSelected, 'key', '_timeline')]]"
                      type="date_histogram"
                      count="0"
                      field="[[getDateProperty(item.dateCollection, item.dateSelected, 'field')]]"
                      interval="[[item.intervalSelected]]"
                      nested-aggregations="[[buildArray(item.entityAggregation)]]"
                      filters="[]"
                      ejs-aggregation="{{item.dateAggregation}}">
                    </elastic-client-aggregation-builder>

                    <template is="dom-if" if="[[item.dateAggregation]]">
                      <build-and-run-query
                        query="[[thisPageQuery]]"
                        client="[[esClient]]"
                        index-name="[[esConfig.esIndex]]"
                        index-types="[[esConfig.esType]]"
                        aggregations="[[buildArray(item.dateAggregation)]]"
                        page-size="0"
                        properties-ready="{{processRequest}}"
                        source-include="[[getSourceIncludes(serverConfig.sendSearchesDirectlyToES, esConfig.timestamp, esConfig.uid)]]"
                        transform-config="[[createTimelineConfig(item.dateCollection, item.dateSelected, item.entity, pageConfig, pageId)]]"
                        transform-function="[[transforms.entity.timelines]]"
                        error="{{item.timelineError}}"
                        loading="{{item.timelineLoading}}"
                        results="{{item.timelineResults}}">
                      </build-and-run-query>
                    </template>
                  </template>
                </template>

                <template is="dom-if" if="[[item.entity.isLocation]]">
                  <template is="dom-if" if="[[isMapVisible(item.aggregatedDataLoading, item.aggregatedDataResults, item.loadData)]]">
                    <leaflet-wrapper
                      cluster-markers
                      restamp
                      text-property="textAndCount"
                      data="[[item.aggregatedDataResults]]">
                    </leaflet-wrapper>

                    <icon-button slot="title" class="scroll-button" icon="list" title-tooltip="Scroll to [[item.entity.title]] List (Below Map)" on-tap="scrollBelowMap"></icon-button>
                  </template>
                </template>

                <template is="dom-if" if="[[!item.entity.isImage]]">
                  <aggregation-query-and-display
                    id$="[[item.entity.key]]_list"
                    hide-bar-chart="[[!item.loadData]]"
                    aggregation-name="[[item.entity.key]]"
                    aggregation-field="[[item.entity.field]]"
                    selected-property="[[item.entity.key]]"
                    selected="{{filterCollection}}"
                    query="[[thisEntityQuery]]"
                    client="[[esClient]]"
                    index-name="[[esConfig.esIndex]]"
                    index-types="[[esConfig.esType]]"
                    filter-list="[[filterList]]"
                    properties-ready="[[processRequest]]"
                    transform-config="[[createExtractionConfig(item.entity, pageConfig, pageId)]]"
                    transform-function="[[transforms.entity.extractions]]"
                    data="{{item.aggregatedDataResults}}"
                    error-message="{{item.aggregatedDataError}}"
                    header-data-name="[[item.entity.titlePlural]]"
                    header-counts-name="[[serverConfig.resultNamePlural]]"
                    header-entity-name="[[pageName]]"
                    limit="50"
                    loading="{{item.aggregatedDataLoading}}"
                    show-checkboxes
                    show-double-bar-chart="[[isEntity(item.entity)]]">
                  </aggregation-query-and-display>
                </template>

                <template is="dom-if" if="[[item.entity.isImage]]">
                  <image-query-and-display
                    hide-images="[[!item.loadData]]"
                    aggregation-field="[[item.entity.field]]"
                    aggregation-name="[[item.entity.key]]"
                    client="[[esClient]]"
                    filter-list="[[filterList]]"
                    header-data-name="[[item.entity.titlePlural]]"
                    header-counts-name="[[serverConfig.resultNamePlural]]"
                    header-entity-name="[[pageName]]"
                    index-name="[[esConfig.esIndex]]"
                    index-types="[[esConfig.esType]]"
                    properties-ready="[[processRequest]]"
                    query="[[thisEntityQuery]]"
                    transform-config="[[createExtractionConfig(item.entity, pageConfig, pageId)]]"
                    transform-function="[[transforms.entity.extractions]]"
                    small-image-style-class="[[findBlurStyleClass(blurImages)]]"
                    large-image-style-class="[[findBlurStyleClass(blurImages, 'large')]]"
                    error-message="{{item.aggregatedDataError}}"
                    images="{{item.aggregatedDataResults}}"
                    limit="50"
                    loaded-images="{{item.aggregatedSubset}}"
                    loading="{{item.aggregatedDataLoading}}"
                    selected-property="[[item.entity.key]]"
                    selected="{{filterCollection}}"
                    show-checkboxes>
                  </image-query-and-display>
                </template>

                <template is="dom-if" if="[[item.aggregatedDataResults.length]]">
                  <terms-transformer
                    category="[[item.entity.title]]"
                    object="{{entityFilters}}"
                    object-property="[[item.entity.key]]"
                    list="[[getFacetsList(filterCollection, item.entity.key, filterCollection.*)]]"
                    text-function="[[getTextFunction(item.aggregatedDataResults)]]">
                  </terms-transformer>

                  <copy-button slot="title" data="[[item.aggregatedDataResults]]" name="[[item.entity.titlePlural]]" text-function="[[createCopyTextFunction(item.entity.isLocation)]]"></copy-button>
                </template>

                <div class="layout horizontal center fields-menu bottom-margin">
                  <template is="dom-if" if="[[!item.timelineLoading]]">
                    <template is="dom-if" if="[[!item.timelineResults.sparklines.length]]">
                      <div>No Timelines [[item.entity.title]] v. [[getDateProperty(item.dateCollection, item.dateSelected, 'title')]]</div>
                    </template>

                    <template is="dom-if" if="[[item.timelineResults.sparklines.length]]">
                      <div>[[getDateProperty(item.dateCollection, item.dateSelected, 'title')]] [[item.timelineResults.begin]] - [[item.timelineResults.end]]</div>
                    </template>
                  </template>

                  <div class="flex"></div>

                  <dropdown-menu
                    data="[[item.dateList]]"
                    label="Date"
                    no-label-float
                    selected="{{item.dateSelected}}"
                    value-property="key">
                  </dropdown-menu>

                  <dropdown-menu
                    data='[{"title":"Daily (Slow)","value":"day"},{"title":"Weekly","value":"week"},{"title":"Monthly","value":"month"}]'
                    label="Date"
                    no-label-float
                    selected="{{item.intervalSelected}}">
                  </dropdown-menu>
                </div>

                <elastic-error error="[[item.timelineError]]" message="{{item.timelineErrorMessage}}"></elastic-error>

                <template is="dom-if" if="[[!item.timelineResults.sparklines.length]]">
                  <status-text
                    count="[[item.timelineResults.sparklines.length]]"
                    error="[[item.timelineErrorMessage]]"
                    label="Timelines"
                    loading="[[item.timelineLoading]]"
                    empty="">
                  </status-text>
                </template>

                <template is="dom-if" if="[[!item.timelineLoading]]">
                  <template is="dom-if" if="[[item.timelineResults.sparklines.length]]">
                    <template is="dom-if" if="[[!esConfig.hideTimelines]]">
                      <sparkline-list
                        data="[[item.timelineResults.sparklines]]"
                        hide-sparkline-chart="[[!item.loadData]]"
                        limit="50">
                      </sparkline-list>
                    </template>

                    <div class="layout horizontal center bottom-margin">
                      <button-action icon="timeline" text="[[createBarChartButtonText(item.showBarChart)]]" click-listener="[[createToggleBarChartListener(index)]]"></button-action>
                    </div>

                    <zoomable-bar-chart
                      bar-property="date"
                      data="[[item.timelineResults.histogram]]"
                      default-label="Unidentified [[item.entity.titlePlural]]"
                      display-filter-text
                      height="300"
                      interval="[[item.intervalSelected]]"
                      label-property="text"
                      load="[[item.showBarChart]]"
                      loading="[[item.timelineLoading]]"
                      selected="{{filterCollection}}"
                      selected-property="[[getDateProperty(item.dateCollection, item.dateSelected, 'key')]]"
                      source="[[serverConfig.resultNamePlural]]"
                      stack-property="data"
                      timeline>
                    </zoomable-bar-chart>

                    <terms-transformer
                      category="[[getDateProperty(item.dateCollection, item.dateSelected, 'title')]]"
                      object="{{entityFilters}}"
                      object-property="[[getDateProperty(item.dateCollection, item.dateSelected, 'key')]]"
                      list="[[getDateFacetsList(filterCollection, item.dateCollection, item.dateSelected, 'key', filterCollection.*)]]">
                    </terms-transformer>
                  </template>
                </template>
              </section-wrapper>

              <section-wrapper slot="bottom"
                error="[[item.aggregatedDataError]]"
                icon="[[item.entity.icon]]"
                loading="[[item.aggregatedDataLoading]]"
                no-data="[[!item.aggregatedDataResults.length]]"
                section-title="[[item.sectionTitle]]"
                selected="[[item.showData]]"
                style-class="[[item.entity.styleClass]]"
                on-tapped-changed="showSectionAndRunQueries"
                hide-section-content
                show-load-icon
                tappable>
              </section-wrapper>
            </template>

            <template is="dom-if" if="[[pageConfig.isImage]]">
              <section-wrapper slot="top"
                class$="[[findShowDataStyleClass(showImageMatches)]]"
                icon="[[esConfig.imageField.icon]]"
                loading="[[imageSearchLoading]]"
                no-data="[[!imageSearchMatches.length]]"
                section-title="[[createSimilarImageMatchesTitle(imageSearchLoading, imageSearchMatches.length)]]"
                style-class="[[esConfig.imageField.styleClass]]"
                show-load-icon>

                <auto-paginated-image-gallery
                  class="results-gallery"
                  large-image-style-class="[[findBlurStyleClass(blurImages, 'large')]]"
                  new-tab
                  page-size="100"
                  show-labels
                  small-image-style-class="[[findBlurStyleClass(blurImages)]]"
                  images="[[imageSearchMatches]]">
                </auto-paginated-image-gallery>
              </section-wrapper>

              <section-wrapper slot="bottom"
                icon="[[esConfig.imageField.icon]]"
                loading="[[imageSearchLoading]]"
                no-data="[[!imageSearchMatches.length]]"
                section-title="[[createSimilarImageMatchesTitle(imageSearchLoading, imageSearchMatches.length)]]"
                style-class="[[esConfig.imageField.styleClass]]"
                on-tapped-changed="showSimilarImageMatchesSection"
                hide-section-content
                show-load-icon
                tappable>
              </section-wrapper>
            </template>
          </dual-column>
        </div>

        <div class="page-column page-single-column">
          <section-wrapper
            icon="fa:filter"
            section-title="[[createFilterSectionTitle(filterList)]]"
            hide-section-content="[[!filterList.length]]">

            <template is="dom-repeat" items="[[searchFields]]">
              <selected-facets-display
                color-map="[[colorMap]]"
                facets="{{entityFilters}}"
                facet-key="[[item.key]]"
                hide-remove-button="[[item.isDate]]">
              </selected-facets-display>
            </template>
          </section-wrapper>

          <section-wrapper
            icon="av:web-asset"
            section-title="[[searchTitle]]"
            class="results-section">

            <div slot="title" class="layout horizontal center fields-menu">
              <div>Sort By</div>

              <dropdown-menu
                data="[[dateMenu.fields]]"
                label="Date"
                no-label-float
                selected="{{dateMenu.selected}}"
                value-property="field">
              </dropdown-menu>
            </div>

            <export-button
              slot="title"
              data="[[searchResultsShown]]"
              export-endpoint="[[findDigUrl(serverConfig.pathPrefix, 'export')]]"
              search-fields="[[searchFields]]"
              transform-csv-function="[[transforms.export.createExportDataForCsv]]"
              transform-pdf-function="[[transforms.export.createExportDataForPdf]]">
            </export-button>

            <template is="dom-if" if="[[searchError]]">
              <elastic-error error="[[searchError]]" message="{{searchErrorMessage}}"></elastic-error>
              <div class="results-error">[[searchErrorMessage]]</div>
            </template>

            <result-list
              text-property="title"
              query-results="[[searchResults]]"
              total-results="{{searchTotal}}"
              shown-results="{{searchResultsShown}}"
              page="{{searchPage}}"
              page-size="10"
              loading="[[searchLoading]]"
              pretty-name="[[serverConfig.resultNamePlural]]"
              pretty-name-singular="[[serverConfig.resultNameSingular]]"
              header="{{searchTitle}}"
              client="[[esClient]]"
              id-field="_id"
              index-name="[[esConfig.esIndex]]"
              index-types="[[esConfig.esType]]"
              search-fields="[[searchFields]]"
              series-data-type="measurement"
              source-include-cached-page='["raw_content"]'
              source-include-nested-data="[[getSourceIncludes(serverConfig.sendSearchesDirectlyToES, esConfig.timestamp, esConfig.uid)]]"
              source-include-series='["knowledge_graph.event_date.key","knowledge_graph.value.key"]'
              transform-cached-page="[[transforms.entity.cache]]"
              transform-nested-data="[[transforms.entity.nestedResults]]"
              transform-series-config='{"dateField":"_source.knowledge_graph.event_date","numberField":"_source.knowledge_graph.value"}'
              transform-series-function="[[transforms.entity.series]]"
              small-image-style-class="[[findBlurStyleClass(blurImages)]]"
              large-image-style-class="[[findBlurStyleClass(blurImages, 'large')]]"
              newline-tag="[[esConfig.newlineTag]]"
              hide-cached-page="[[serverConfig.hideCachedPage]]"
              hide-confidences
              tag-manager="[[tagManager]]">
            </result-list>
          </section-wrapper>
        </div>
      </div>
    </template>
  </template>

  <script>
  (function() {
    'use strict';

    Polymer({
      /* globals _, DigBehaviors */
      is: 'entity-page',

      behaviors: [
        DigBehaviors.PageBehavior
      ],

      properties: {
        aggregationFields: {
          type: Array
        },

        blurImages: {
          type: Boolean
        },

        builderCallbacks: {
          type: Object,
          value: function() {
            return {
              dates: function(items) {
                return items;
              },
              terms: function(items) {
                return {
                  must: items
                };
              }
            };
          }
        },

        buildersConfig: {
          type: Object
        },

        cases: {
          type: Array
        },

        clientConfig: {
          type: Object
        },

        clientConfigError: {
          type: Object
        },

        clientConfigFields: {
          type: Object
        },

        clientConfigLoading: {
          type: Boolean
        },

        colorMap: {
          type: Object
        },

        configHeader: {
          computed: 'createAuthHeader(serverConfig)',
          type: Object
        },

        dateMenu: {
          type: Object
        },

        domain: {
          computed: 'findDomain(parameters, serverConfig)',
          notify: true,
          type: String
        },

        emailAddress: {
          type: String
        },

        entityFilters: {
          type: Object
        },

        esClient: {
          type: Object
        },

        esConfig: {
          type: Object
        },

        filterCollection: {
          type: Object
        },

        filterList: {
          type: Array
        },

        hasHistory: {
          type: Boolean
        },

        imageFaceSearchLoading: {
          type: Boolean,
          value: false
        },

        imageFaceSearchThreshold: {
          type: Number,
          value: 0.1
        },

        imageSearchLoading: {
          type: Boolean,
          value: false
        },

        imageSearchMatches: {
          type: Array,
          value: function() {
            return [];
          }
        },

        imageSimilaritySearchLoading: {
          type: Boolean,
          value: false
        },

        imageSimilaritySearchThreshold: {
          type: Number,
          value: 0.3
        },

        logger: {
          type: Object
        },

        logMessage: {
          type: Object
        },

        menuOpened: {
          type: Boolean
        },

        notifications: {
          type: Boolean
        },

        notificationInterval: {
          type: String
        },

        pageConfig: {
          type: Object
        },

        pageId: {
          type: String
        },

        pageName: {
          notify: true,
          type: String
        },

        parameters: {
          computed: 'getUrlParameters()',
          observer: 'updateProcessRequest',
          type: Object
        },

        processRequest: {
          type: Boolean,
          value: false
        },

        profileManager: {
          type: Object
        },

        searchError: {
          type: Object
        },

        searchErrorMessage: {
          type: String
        },

        searchFields: {
          type: Array
        },

        searchLoading: {
          type: Boolean
        },

        searchPage: {
          type: Number
        },

        searchResults: {
          type: Array
        },

        searchResultsShown: {
          type: Array
        },

        searchTitle: {
          type: String
        },

        searchTotal: {
          type: Number
        },

        serverConfig: {
          type: Object
        },

        showImageMatches: {
          type: Boolean,
          value: false
        },

        stateHistory: {
          type: Array
        },

        tagManager: {
          type: Object
        },

        thisEntityQuery: {
          type: Object
        },

        thisPageQuery: {
          type: Object
        },

        thisPageFilterQuery: {
          type: Object
        },

        transforms: {
          type: Object
        },

        userId: {
          type: String
        },

        userLoading: {
          type: Boolean
        },

        userSettingsDialogCallbacks: {
          type: Object
        }
      },

      observers: [
        'findImageMatches(esConfig, pageConfig, pageId, transforms)',
        'removeDisabledFromFilterCollection(entityFilters.*)'
      ],

      attached: function() {
        this.assignWindowProperties(this);
      },

      createBarChartButtonText: function(shown) {
        return (shown ? 'Hide' : 'Show') + ' Detailed Timeline';
      },

      createCopyTextFunction: function(isLocation) {
        if(!isLocation) {
          return function(item) {
            return item.id;
          };
        }
        return function(item) {
          if(item.textAndCount && item.textAndCount.indexOf(',') >= 0) {
            return item.textAndCount.substring(0, item.textAndCount.indexOf(','));
          }
          return item.textAndCount;
        };
      },

      createExtractionConfig: function(entityConfig, pageConfig, id) {
        if(!entityConfig || !pageConfig || !id) {
          return undefined;
        }
        return {
          entity: entityConfig,
          page: pageConfig,
          id: id
        };
      },

      createSimilarImageMatchesTitle: function(loading, size) {
        if(loading) {
          return 'Loading Similar Image Matches...';
        }
        return (size || 'No').toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',') + ' Similar Image Match' + (size === 1 ? '' : 'es');
      },

      createSectionTitle: function(size, config) {
        if(config.loading) {
          return 'Loading' + (config.sayOther ? ' Other ' : ' ') + config.namePlural + '...';
        }
        if(config.error) {
          return (config.sayOther ? 'Other ' : '') + config.namePlural + ' ' + config.error;
        }
        var sizeString = (size || 'No').toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        var totalCountString = config.totalCount !== undefined && config.totalCount > size ? ' of ' + config.totalCount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',') : '';
        return sizeString + totalCountString + (config.sayOther ? ' Other ' : ' ') + (size !== 1 || config.totalCount ? config.namePlural : config.name);
      },

      createSectionTitleConfig: function(pageConfig, searchFieldsObject, error, loading, totalCount) {
        if(!pageConfig || !searchFieldsObject) {
          return undefined;
        }
        return {
          error: error,
          loading: loading,
          name: searchFieldsObject.title,
          namePlural: searchFieldsObject.titlePlural,
          sayOther: (pageConfig.key === searchFieldsObject.key),
          totalCount: totalCount
        };
      },

      createTimelineConfig: function(dateCollection, dateSelected, entityConfig, pageConfig, id) {
        if(!dateCollection || !dateSelected || !entityConfig || !pageConfig || !id) {
          return undefined;
        }
        return {
          entity: entityConfig,
          name: dateCollection[dateSelected].key + '_timeline',
          page: pageConfig,
          id: id
        };
      },

      createToggleBarChartListener: function(index) {
        var self = this;
        return {
          onClick: function() {
            self.set(['aggregationFields', index, 'showBarChart'], !self.aggregationFields[index].showBarChart);
          }
        };
      },

      findImageMatches: function(esConfig, pageConfig, pageId, transforms) {
        if(esConfig && pageConfig && pageConfig.isImage && pageId && transforms && transforms.config && transforms.config.imageSrc) {
          var imageLink = transforms.config.imageSrc(pageId, esConfig);
          this.imageSearchLoading = true;
          this.findImageMatchesOfType('Face', 'imageFaceSearch', imageLink, this.imageFaceSearchThreshold);
          this.findImageMatchesOfType('Similarity', 'imageSimilaritySearch', imageLink, this.imageSimilaritySearchThreshold);
        }
      },

      findImageMatchesOfType: function(searchType, searchName, imageLink, imageThreshold) {
        var authConfig = (this.serverConfig.imageServiceConfig.auth || {});
        var auth = authConfig.user && authConfig.password ? 'Basic ' + btoa(authConfig.user + ':' + authConfig.password) : '';
        var endpointConfig = (this.serverConfig.imageServiceConfig.endpoint || {});
        var endpoint = endpointConfig.link;
        var hostConfig = (this.serverConfig.imageServiceConfig.host || {});
        var host = hostConfig[searchType.toLowerCase()];

        if(this.logger) {
          this.logger.log('ImageSearch' + searchType + '-Start', '["' + this.pageId + '"]');
        }

        if(auth && endpoint && host) {
          var requestElement = this.$$('#' + searchName);
          requestElement.body = {
            data: imageLink
          };
          requestElement.body.options = '{' + '"max_returned":1000,"near_dup":1,"near_dup_th":' + imageThreshold + '}';
          requestElement.url = host + endpoint;
          requestElement.headers = requestElement.headers || {};
          requestElement.headers.Authorization = auth;
          requestElement.generateRequest();
        }
      },

      findNoBlurStyleClass: function(blur) {
        return (blur ? '' : 'no-blur');
      },

      findShowDataStyleClass: function(showData) {
        return showData ? '' : 'hide';
      },

      getDateProperty: function(collection, selected, property, suffix) {
        if(!collection || !selected || !property || !collection[selected] || !collection[selected][property]) {
          return undefined;
        }
        return collection[selected][property] + (suffix || '');
      },

      handleImageFaceSearchResults: function(event) {
        if(event.detail.error || event.detail.response.error) {
          this.handleImageResults('Face', [], [], [], this.imageFaceSearchThreshold, (event.detail.error || event.detail.response.error));
          return;
        }

        /* jscs:disable requireCamelCaseOrUpperCaseIdentifiers */
        var response = (event.detail.response || {}).AllSimilarFaces || [];
        /* jscs:enable requireCamelCaseOrUpperCaseIdentifiers */
        if(response && response.length) {
          /* jscs:disable requireCamelCaseOrUpperCaseIdentifiers */
          var imageUrls = response[0].SimilarFaces.CachedImageURLs;
          var imageIds = response[0].SimilarFaces.ImageSha1s;
          var imageDistances = response[0].SimilarFaces.Distances;
          /* jscs:enable requireCamelCaseOrUpperCaseIdentifiers */

          this.handleImageResults('Face', imageUrls, imageIds, imageDistances, this.imageFaceSearchThreshold);
        }
      },

      handleImageSimilaritySearchResults: function(event) {
        if(event.detail.error || event.detail.response.error) {
          this.handleImageResults('Similarity', [], [], [], this.imageSimilaritySearchThreshold, (event.detail.error || event.detail.response.error));
          return;
        }

        var response = (event.detail.response || {}).images || [];
        if(response && response.length) {
          /* jscs:disable requireCamelCaseOrUpperCaseIdentifiers */
          var imageUrls = response[0].similar_images.cached_image_urls;
          var imageIds = response[0].similar_images.sha1;
          var imageDistances = response[0].similar_images.distance;
          /* jscs:enable requireCamelCaseOrUpperCaseIdentifiers */

          this.handleImageResults('Similarity', imageUrls, imageIds, imageDistances, this.imageSimilaritySearchThreshold);
        }
      },

      handleImageResults: function(searchType, imageUrls, imageIds, imageDistances, imageThreshold, error) {
        var linkFunction = this.transforms && this.transforms.entity ? this.transforms.entity.entityPageLinkForImageId : null;
        var pageId = this.pageId;

        // Remove images with distances over the threshold.
        var sliceIndex = _.findIndex(imageDistances, function(distance) {
          return _.toNumber(distance) > imageThreshold;
        });

        var imageResults = imageIds.map(function(id, index) {
          return {
            id: id,
            link: (linkFunction ? linkFunction(id) : ''),
            rank: imageDistances[index],
            source: imageUrls[index]
          };
        }).slice(0, sliceIndex < 0 ? imageIds.length : sliceIndex);

        this.imageSearchMatches = (!this.imageSearchMatches.length ? imageResults : _.uniqBy(this.imageSearchMatches.concat(imageResults).filter(function(result) {
          return result.id !== pageId;
        }).sort(function(a, b) {
          return a.rank - b.rank;
        }), 'id')).map(function(result, index) {
          result.name = 'Match #' + (index + 1);
          return result;
        });

        this.imageSearchLoading = this.imageFaceSearchLoading || this.imageSimilaritySearchLoading;

        if(error && this.logger) {
          this.logger.log('ImageSearch' + searchType + '-Error', '{"type":"' + searchType + '","name":"' + this.pageId + '"}');
        }
      },

      isEntity: function(searchFieldsConfig) {
        return searchFieldsConfig.link === 'entity';
      },

      isMapVisible: function(loading, data, opened) {
        // Ensure the map section is opened prior to rendering.
        return !loading && !!(data && data.length) && opened;
      },

      scrollBelowMap: function(event) {
        var list = this.$$('#' + event.model.item.entity.key + '_list');
        list.scrollIntoView();
      },

      showSimilarImageMatchesSection: function(event) {
        if(event.detail.value) {
          var self = this;
          this.aggregationFields.forEach(function(aggregationField, index) {
            self.set(['aggregationFields', index, 'loadData'], false);
            self.set(['aggregationFields', index, 'showData'], false);
          });
          this.showImageMatches = true;
        }
      },

      showSectionAndRunQueries: function(event) {
        if(event.detail.value && !event.model.item.aggregatedDataError && !event.model.item.aggregatedDataLoading && event.model.item.aggregatedDataResults.length) {
          var self = this;
          this.aggregationFields.forEach(function(aggregationField, index) {
            self.set(['aggregationFields', index, 'loadData'], (aggregationField.entity.key === event.model.item.entity.key));
            self.set(['aggregationFields', index, 'showData'], (aggregationField.entity.key === event.model.item.entity.key));
          });
          this.showImageMatches = false;
        }
      },

      updateProcessRequest: function(parameters) {
        if(!parameters.state) {
          this.set('processRequest', true);
        }
      },

      /************ FILTER ************/
      createFilterSectionTitle: function(filterList) {
        return (filterList.length || 'No') + ' Filter' + (filterList.length === 1 ? '' : 's');
      },

      doesHaveFilters: function(entityFilters) {
        var answer = false;
        _.keys(entityFilters).forEach(function(type) {
          _.keys(entityFilters[type]).forEach(function(term) {
            if(entityFilters[type][term].enabled) {
              answer = true;
            }
          });
        });
        return answer;
      },

      getDateFacetsList: function(facetsCollection, dateCollection, dateSelected, keyProperty) {
        if(!dateCollection || !dateSelected || !keyProperty) {
          return undefined;
        }
        var key = dateCollection[dateSelected] ? dateCollection[dateSelected][keyProperty] : undefined;
        if(key && facetsCollection[key] && facetsCollection[key].length === 2) {
          return [this.transforms.config.formatDate(facetsCollection[key][0]) + ' to ' + this.transforms.config.formatDate(facetsCollection[key][1])];
        }
        return [];
      },

      getFacetsList: function(collection, key) {
        return collection[key];
      },

      getTextFunction: function(data) {
        return function(id) {
          var text = '';

          if(data) {
            data.forEach(function(object) {
              if(id === object.id) {
                text = object.text;
                return;
              }
            });
          }
          return text;
        };
      },

      /**
       * Handles removing a filter using the selected-facets-display.
       */
      removeDisabledFromFilterCollection: function() {
        var self = this;
        _.keys(this.entityFilters).forEach(function(type) {
          _.keys(self.entityFilters[type]).forEach(function(term) {
            var key = self.entityFilters[type][term].key;
            if(!self.entityFilters[type][term].enabled && self.filterCollection[type] && self.filterCollection[type].indexOf(key) >= 0) {
              self.set(['filterCollection', type], self.filterCollection[type].map(function(id) {
                return id;
              }).filter(function(id) {
                return id !== key;
              }));
            }
          });
        });
      }
    });
  })();
  </script>
</dom-module>
