<!--
Copyright 2018 Next Century Corporation

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/dig-logger/dig-logger.html">
<link rel="import" href="../../bower_components/dropdown-menu/dropdown-menu.html">
<link rel="import" href="../../bower_components/elastic-client/elastic-client.html">
<link rel="import" href="../../bower_components/elastic-error/elastic-error.html">
<link rel="import" href="../../bower_components/export-button/export-button.html">
<link rel="import" href="../../bower_components/export-button/export-dialog.html">
<link rel="import" href="../../bower_components/facet-panel/facet-panel.html">
<link rel="import" href="../../bower_components/icon-button/icon-button.html">
<link rel="import" href="../../bower_components/image-gallery/image-gallery.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-dropdown/iron-dropdown.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/json-combine/json-combine.html">
<link rel="import" href="../../bower_components/loading-spinner/loading-spinner.html">
<link rel="import" href="../../bower_components/lodash-import/lodash.html">
<link rel="import" href="../../bower_components/log-creator/log-creator.html">
<link rel="import" href="../../bower_components/nested-list/nested-list.html">
<link rel="import" href="../../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../../bower_components/paper-styles/shadow.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/profile-manager/profile-manager.html">
<link rel="import" href="../../bower_components/query-builder/query-builder.html">
<link rel="import" href="../../bower_components/query-transformer/query-transformer.html">
<link rel="import" href="../../bower_components/result-list/result-list.html">
<link rel="import" href="../../bower_components/save-case-dialog/save-case-dialog.html">
<link rel="import" href="../../bower_components/search-fields-dialog/search-fields-button.html">
<link rel="import" href="../../bower_components/search-fields-dialog/search-fields-dialog.html">
<link rel="import" href="../../bower_components/state-manager/state-manager.html">
<link rel="import" href="../../bower_components/tag-manager/tag-manager.html">
<link rel="import" href="../../bower_components/user-settings-dialog/user-settings-button.html">
<link rel="import" href="../../bower_components/user-settings-dialog/user-settings-dialog.html">
<link rel="import" href="../../elements/behaviors.html">
<link rel="import" href="../../elements/database-details/database-details.html">
<link rel="import" href="../../elements/transform-functions/transform-functions.html">
<link rel="import" href="../../styles/page-styles.html">

<link rel="import" href="../../bower_components/dig-ui-search-box/editable-button.html">
<link rel="import" href="../../bower_components/dig-ui-search-box/search-box.html">
<link rel="import" href="../../bower_components/dig-ui-search-box/search-strategy.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">

<dom-module id="search-page">
  <template>
    <style include="iron-flex iron-flex-reverse iron-flex-alignment iron-flex-factors iron-positioning"></style>
    <style include="page-styles"></style>

    <style>
      :host {
        display: block;
        @apply --layout-fullbleed;
      }

      #pageDrawer {
        height: 100%;
        --paper-drawer-panel-left-drawer-container: {
          background-color: var(--paper-grey-100);
          border-right: 1px solid var(--paper-grey-300);
        };
      }

      #pageNavbar {
        background-color: var(--navbar-color);
        color: white;
        padding: 10px;
        --paper-toolbar-height: 50px;
        --paper-toolbar-sm-height: 50px;
        --paper-toolbar-content: {
          padding: 0;
        };
        /* Add shadow. */
        position: relative;
        z-index: 5;
        @apply --shadow-elevation-4dp;
      }

      #pageNavbar.bigger {
        --paper-toolbar-height: 70px;
        --paper-toolbar-sm-height: 70px;
      }

      #searchTermList {
        background-color: var(--paper-grey-100);
        color: var(--paper-grey-900);
        max-height: 200px;
        min-height: 45px;
        overflow-y: auto;
        padding: 10px 10px 5px;
        --paper-toolbar-height: auto;
        --paper-toolbar-sm-height: auto;
        --paper-toolbar-content: {
          padding: 0;
        };
        /* Add shadow. */
        position: relative;
        z-index: 4;
        @apply --shadow-elevation-4dp;
      }

      #pageSearch {
        --paper-header-panel-container: {
          background-color: white;
        };
      }

      #searchHeader,
      #searchTimeline {
        background-color: var(--paper-grey-100);
        padding: 10px;
        /* Fix box-shadow. */
        position: relative;
        z-index: 3;
      }

      #searchTimeline {
        /* Fix box-shadow. */
        z-index: 2;
      }

      .search-header-text {
        font-size: 20px;
        font-weight: 500;
        /* Match the height of the export button. */
        line-height: 30px;
        /* Needed to fix flexbox layout issues in newer browsers. */
        display: -webkit-box;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: normal;
        word-break: break-word;
        -webkit-line-clamp: 1;
        -webkit-box-orient: vertical;
      }

      .no-facets-text {
        color: var(--paper-grey-900);
        font-size: 16px;
        font-weight: 500;
        line-height: 30px;
      }

      .timeline-info-text {
        color: var(--paper-grey-900);
        font-size: 14px;
        font-weight: 500;
        line-height: 24px;
      }

      #searchResultList {
        --result-list-max-height: none;
      }
    </style>

    <iron-ajax
      auto
      handle-as="json"
      url="/dig-ui/config"
      last-response="{{serverConfig}}">
    </iron-ajax>

    <template is="dom-if" if="[[serverConfig.overrideConfig]]">
      <transform-functions
        client-config="[[serverConfig.overrideConfig]]"
        domain="[[domain]]"
        server-config="[[serverConfig]]"
        es-config="{{esConfig}}"
        transforms="{{transforms}}">
      </transform-functions>

      <json-combine
        data-in1="[[serverConfig.overrideConfig]]"
        data-in2="{}"
        data-out="{{clientConfigFields}}"
        combine-function="[[transforms.config.fields]]">
      </json-combine>
    </template>

    <template is="dom-if" if="[[!serverConfig.overrideConfig]]">
      <iron-ajax
        auto="[[exists(configHeader)]]"
        handle-as="json"
        headers="[[configHeader]]"
        url="[[concat(serverConfig.configEndpoint, domain)]]"
        with-credentials
        loading="{{clientConfigLoading}}"
        last-error="{{clientConfigError}}"
        last-response="{{clientConfig}}">
      </iron-ajax>

      <transform-functions
        client-config="[[clientConfig]]"
        domain="[[domain]]"
        server-config="[[serverConfig]]"
        es-config="{{esConfig}}"
        transforms="{{transforms}}">
      </transform-functions>

      <json-combine
        data-in1="[[clientConfig]]"
        data-in2="{}"
        data-out="{{clientConfigFields}}"
        combine-function="[[transforms.config.fields]]">
      </json-combine>
    </template>

    <json-combine
      data-in1="[[clientConfigFields]]"
      data-in2="{}"
      data-out="{{searchFields}}"
      combine-function="[[transforms.config.searchFields]]">
    </json-combine>

    <json-combine
      data-in1="[[searchFields]]"
      data-in2="{}"
      data-out="{{colorMap}}"
      combine-function="[[transforms.config.colorMap]]">
    </json-combine>

    <json-combine
      data-in1="[[searchFields]]"
      data-in2="{}"
      data-out="{{dateFieldsToProperties}}"
      combine-function="[[transforms.config.dateFieldsToProperties]]">
    </json-combine>

    <json-combine
      data-in1="[[searchFields]]"
      data-in2="{}"
      data-out="{{dateMenu}}"
      combine-function="[[transforms.config.dateMenu]]">
    </json-combine>

    <json-combine
      data-in1="[[searchFields]]"
      data-in2="{}"
      data-out="{{datePropertiesToKeys}}"
      combine-function="[[transforms.config.datePropertiesToKeys]]">
    </json-combine>

    <json-combine
      data-in1="[[searchFields]]"
      data-in2="{}"
      data-out="{{searchFieldsDialogConfig}}"
      combine-function="[[transforms.config.searchFieldsDialogConfig]]">
    </json-combine>

    <json-combine
      data-in1="[[searchFields]]"
      data-in2="{}"
      data-out="{{searchFieldsCollection}}"
      combine-function="[[transforms.config.searchFieldsCollection]]">
    </json-combine>

    <json-combine
      data-in1="[[searchFields]]"
      data-in2="{}"
      data-out="{{searchKeys}}"
      combine-function="[[transforms.config.searchKeys]]">
    </json-combine>

    <json-combine
      data-in1="[[searchFields]]"
      data-in2="{}"
      data-out="{{searchParameters}}"
      combine-function="[[transforms.config.searchParameters]]">
    </json-combine>

    <json-combine
      data-in1="[[searchFields]]"
      data-in2="{}"
      data-out="{{networkExpansionParameters}}"
      combine-function="[[transforms.config.networkExpansionParameters]]">
    </json-combine>

    <json-combine
      data-in1="[[searchFields]]"
      data-in2="{}"
      data-out="{{sortedSearchFields}}"
      combine-function="[[transforms.config.sortSearchFieldsAlphabetically]]">
    </json-combine>

    <json-combine
      data-in1="[[searchFields]]"
      data-in2="{}"
      data-out="{{freeTextSearchFields}}"
      combine-function="[[transforms.config.freeTextSearchFields]]">
    </json-combine>

    <json-combine
      data-in1="[[datePropertiesToKeys]]"
      data-in2="{}"
      data-out="{{searchQuery}}"
      combine-function="[[transforms.search.createSearchQuery]]">
    </json-combine>

    <json-combine
      data-in1="[[datePropertiesToKeys]]"
      data-in2="{}"
      data-out="{{facetsQuery}}"
      combine-function="[[transforms.search.createFacetsQuery]]">
    </json-combine>

    <template is="dom-if" if="[[!serverConfig.sendSearchesDirectlyToES]]">
      <query-transformer
        error="{{searchError}}"
        loading="{{searchLoading}}"
        page="{{searchPage}}"
        page-size="10"
        process-request="[[processRequest]]"
        result-config="[[createSearchResultConfig(networkExpansionParameters, networkExpansionParameters.*)]]"
        result-function="[[transforms.search.searchResults]]"
        results="{{searchQueryTransformerResults}}"
        search-parameters="[[searchParameters]]"
        search-config="[[networkExpansionParameters]]"
        search-function="[[searchQuery]]"
        sort-key="[[sortKey]]"
        sort-order="[[sortOrder]]"
        total-count-function="[[createTotalCountFunction()]]"
        total="{{searchTotal}}"
        url="[[esConfig.searchEndpoint]]">
      </query-transformer>

      <json-combine
        data-in1="[[searchQueryTransformerResults]]"
        data-in2="[[searchFields]]"
        data-out="{{searchResults}}"
        combine-function="[[transforms.entity.results]]">
      </json-combine>
    </template>

    <elastic-client
      config="[[serverConfig.esHost]]"
      client="{{esClient}}">
    </elastic-client>

    <query-builder
      config="[[searchFieldsCollection]]"
      data="[[searchParameters]]"
      date-fields="[[dateFieldsToProperties]]"
      stop="[[!processRequest]]"
      query="{{esQuery}}">
    </query-builder>

    <template is="dom-if" if="[[serverConfig.sendSearchesDirectlyToES]]">
      <build-and-run-query
        query="[[esQuery]]"
        client="[[esClient]]"
        index-name="[[esConfig.esIndex]]"
        index-types="[[esConfig.esType]]"
        aggregations="[]"
        page="{{searchPage}}"
        page-size="10"
        properties-ready="[[processRequest]]"
        transform-config="[[searchFields]]"
        transform-function="[[transforms.entity.results]]"
        error="{{searchError}}"
        loading="{{searchLoading}}"
        results="{{searchResults}}"
        total="{{searchTotal}}">
      </build-and-run-query>
    </template>

    <!-- Logger for Search Terms -->
    <dig-logger
      es-client="[[esClient]]"
      es-index="[[serverConfig.logIndexName]]"
      es-type="[[serverConfig.logIndexType]]"
      type="Search-SubmitSearch"
      data="[[logMessage]]"
      username="[[serverConfig.username]]">
    </dig-logger>

    <!-- Logger for Pagination -->
    <dig-logger
      es-client="[[esClient]]"
      es-index="[[serverConfig.logIndexName]]"
      es-type="[[serverConfig.logIndexType]]"
      type="Search-ResultPage"
      data="[[searchPage]]"
      username="[[serverConfig.username]]">
    </dig-logger>

    <!-- Logger for Page View -->
    <dig-logger log-page-view
      es-client="[[esClient]]"
      es-index="[[serverConfig.logIndexName]]"
      es-type="[[serverConfig.logIndexType]]"
      type="Search-Open"
      data="[[parameters.state]]"
      username="[[serverConfig.username]]"
      logger="{{logger}}">
    </dig-logger>

    <log-creator
      object="{{searchParameters}}"
      log-message="{{logMessage}}">
    </log-creator>

    <profile-manager
      build-state-data-function="[[transforms.config.searchState]]"
      client="[[esClient]]"
      function-config="[[searchFields]]"
      index-name="[[serverConfig.profileIndexName]]"
      index-type="[[serverConfig.profileIndexType]]"
      network-expansion-parameters="[[networkExpansionParameters]]"
      query-builder-config="[[searchFieldsCollection]]"
      query-builder-date-fields="[[dateFieldsToProperties]]"
      search-parameters="[[searchParameters]]"
      username="[[serverConfig.username]]"
      blur-images="{{blurImages}}"
      cases="{{cases}}"
      email-address="{{emailAddress}}"
      notifications="{{notifications}}"
      notification-interval="{{notificationInterval}}"
      profile-manager="{{profileManager}}"
      user-id="{{userId}}"
      user-loading="{{userLoading}}">
    </profile-manager>

    <tag-manager
      id="tagManager"
      auth-username="[[serverConfig.configUsername]]"
      auth-password="[[serverConfig.configPassword]]"
      entity-endpoint="[[serverConfig.tagsEntityEndpoint]]"
      extraction-endpoint="[[serverConfig.tagsExtractionEndpoint]]"
      list-endpoint="[[serverConfig.tagsListEndpoint]]"
      project="[[domain]]"
      tag-manager="{{tagManager}}">
    </tag-manager>

    <!-- Must wait for the searchParameters to be defined. -->
    <template is="dom-if" if="[[searchParameters]]">
      <state-manager id="stateManager"
        build-popup-data-function="[[transforms.config.searchTerms]]"
        build-state-data-function="[[transforms.config.searchState]]"
        client="[[esClient]]"
        function-config="[[searchFields]]"
        state-index="[[serverConfig.stateIndexName]]"
        state-type="[[serverConfig.stateIndexType]]"
        state-id="[[parameters.state]]"
        collection="{{searchParameters}}"
        network-expansion="{{networkExpansionParameters}}"
        process-request="{{processRequest}}"
        state-history="{{stateHistory}}"
        has-history="{{hasHistory}}">
      </state-manager>
    </template>

    <save-case-dialog
      id="saveDialog"
      build-popup-data-function="[[transforms.config.searchTerms]]"
      cases="[[cases]]"
      function-config="[[searchFields]]"
      network-expansion-parameters="[[networkExpansionParameters]]"
      profile-manager="[[profileManager]]"
      search-parameters="[[searchParameters]]"
      user-id="[[userId]]">
    </save-case-dialog>

    <bulk-search
      id="bulkSearchDialog"
      search-fields="[[sortedSearchFields]]"
      parameter-key="[[searchFields.0.key]]"
      upload-endpoint="[[findDigUrl(serverConfig.pathPrefix, 'upload')]]"
      search-parameters="{{searchParameters}}"
      process-request="{{processRequest}}"
      build-search-state="[[buildSearchState]]">
    </bulk-search>

    <template is="dom-if" if="[[!esConfig.hideTimelines]]">
      <query-builder
        config="[[searchFieldsCollection]]"
        data="[[searchParameters]]"
        stop="[[!processRequest]]"
        query="{{esQueryWithoutDates}}">
      </query-builder>

      <elastic-client-aggregation-builder
        name="[[createHistogramAggregationName(dateFieldsToProperties, dateMenu.selected)]]"
        type="date_histogram"
        count="0"
        field="[[dateMenu.selected]]"
        interval="year"
        filters="[]"
        ejs-aggregation="{{timelineAggregation.year}}">
      </elastic-client-aggregation-builder>

      <template is="dom-if" if="[[timelineAggregation.year]]" restamp>
        <build-and-run-query
          query="[[esQueryWithoutDates]]"
          client="[[esClient]]"
          index-name="[[esConfig.esIndex]]"
          index-types="[[esConfig.esType]]"
          aggregations="[[buildArray(timelineAggregation.year)]]"
          page-size="0"
          transform-config="[[createHistogramAggregationConfig('year', dateFieldsToProperties, dateMenu.selected, searchParameters, searchParameters.*)]]"
          transform-function="[[transforms.entity.timelines]]"
          error="{{timelineError.year}}"
          loading="{{timelineLoading.year}}"
          results="{{timelineResults.year}}">
        </build-and-run-query>

        <template is="dom-if" if="[[shouldReduceInterval(timelineResults.year)]]" restamp>
          <elastic-client-aggregation-builder
            name="[[createHistogramAggregationName(dateFieldsToProperties, dateMenu.selected)]]"
            type="date_histogram"
            count="0"
            field="[[dateMenu.selected]]"
            interval="month"
            filters="[]"
            ejs-aggregation="{{timelineAggregation.month}}">
          </elastic-client-aggregation-builder>

          <template is="dom-if" if="[[timelineAggregation.month]]" restamp>
            <build-and-run-query
              query="[[esQueryWithoutDates]]"
              client="[[esClient]]"
              index-name="[[esConfig.esIndex]]"
              index-types="[[esConfig.esType]]"
              aggregations="[[buildArray(timelineAggregation.month)]]"
              page-size="0"
              transform-config="[[createHistogramAggregationConfig('month', dateFieldsToProperties, dateMenu.selected, searchParameters, searchParameters.*)]]"
              transform-function="[[transforms.entity.timelines]]"
              error="{{timelineError.month}}"
              loading="{{timelineLoading.month}}"
              results="{{timelineResults.month}}">
            </build-and-run-query>

            <template is="dom-if" if="[[shouldReduceInterval(timelineResults.month)]]" restamp>
              <elastic-client-aggregation-builder
                name="[[createHistogramAggregationName(dateFieldsToProperties, dateMenu.selected)]]"
                type="date_histogram"
                count="0"
                field="[[dateMenu.selected]]"
                interval="week"
                filters="[]"
                ejs-aggregation="{{timelineAggregation.week}}">
              </elastic-client-aggregation-builder>

              <template is="dom-if" if="[[timelineAggregation.week]]" restamp>
                <build-and-run-query
                  query="[[esQueryWithoutDates]]"
                  client="[[esClient]]"
                  index-name="[[esConfig.esIndex]]"
                  index-types="[[esConfig.esType]]"
                  aggregations="[[buildArray(timelineAggregation.week)]]"
                  page-size="0"
                  transform-config="[[createHistogramAggregationConfig('week', dateFieldsToProperties, dateMenu.selected, searchParameters, searchParameters.*)]]"
                  transform-function="[[transforms.entity.timelines]]"
                  error="{{timelineError.week}}"
                  loading="{{timelineLoading.week}}"
                  results="{{timelineResults.week}}">
                </build-and-run-query>

                <template is="dom-if" if="[[shouldReduceInterval(timelineResults.week)]]" restamp>
                  <elastic-client-aggregation-builder
                    name="[[createHistogramAggregationName(dateFieldsToProperties, dateMenu.selected)]]"
                    type="date_histogram"
                    count="0"
                    field="[[dateMenu.selected]]"
                    interval="day"
                    filters="[]"
                    ejs-aggregation="{{timelineAggregation.day}}">
                  </elastic-client-aggregation-builder>

                  <template is="dom-if" if="[[timelineAggregation.day]]" restamp>
                    <build-and-run-query
                      query="[[esQueryWithoutDates]]"
                      client="[[esClient]]"
                      index-name="[[esConfig.esIndex]]"
                      index-types="[[esConfig.esType]]"
                      aggregations="[[buildArray(timelineAggregation.day)]]"
                      page-size="0"
                      transform-config="[[createHistogramAggregationConfig('day', dateFieldsToProperties, dateMenu.selected, searchParameters, searchParameters.*)]]"
                      transform-function="[[transforms.entity.timelines]]"
                      error="{{timelineError.day}}"
                      loading="{{timelineLoading.day}}"
                      results="{{timelineResults.day}}">
                    </build-and-run-query>

                    <template is="dom-if" if="[[shouldReduceInterval(timelineResults.day)]]" restamp>
                      <elastic-client-aggregation-builder
                        name="[[createHistogramAggregationName(dateFieldsToProperties, dateMenu.selected)]]"
                        type="date_histogram"
                        count="0"
                        field="[[dateMenu.selected]]"
                        interval="hour"
                        filters="[]"
                        ejs-aggregation="{{timelineAggregation.hour}}">
                      </elastic-client-aggregation-builder>

                      <template is="dom-if" if="[[timelineAggregation.hour]]" restamp>
                        <build-and-run-query
                          query="[[esQueryWithoutDates]]"
                          client="[[esClient]]"
                          index-name="[[esConfig.esIndex]]"
                          index-types="[[esConfig.esType]]"
                          aggregations="[[buildArray(timelineAggregation.hour)]]"
                          page-size="0"
                          transform-config="[[createHistogramAggregationConfig('hour', dateFieldsToProperties, dateMenu.selected, searchParameters, searchParameters.*)]]"
                          transform-function="[[transforms.entity.timelines]]"
                          error="{{timelineError.hour}}"
                          loading="{{timelineLoading.hour}}"
                          results="{{timelineResults.hour}}">
                        </build-and-run-query>
                      </template>
                    </template>
                  </template>
                </template>
              </template>
            </template>
          </template>
        </template>
      </template>
    </template>

    <iron-ajax
      id="imageSimilaritySearch"
      content-type="application/x-www-form-urlencoded"
      handle-as="json"
      loading="{{imageSimilaritySearchLoading}}"
      method="POST"
      params="{}"
      with-credentials
      on-error="handleImageSimilaritySearchResults"
      on-response="handleImageSimilaritySearchResults">
    </iron-ajax>

    <iron-ajax
      id="imageFaceSearch"
      content-type="application/x-www-form-urlencoded"
      handle-as="json"
      loading="{{imageFaceSearchLoading}}"
      method="POST"
      params="{}"
      with-credentials
      on-error="handleImageFaceSearchResults"
      on-response="handleImageFaceSearchResults">
    </iron-ajax>

    <template is="dom-if" if="[[!serverConfig.hideDatabaseInfo]]">
      <styled-dialog id="databaseDetailDialog" fill header="Database Details" opened="{{openedDatabaseDetail}}">
        <database-details
          client="[[esClient]]"
          index-name="[[esConfig.esIndex]]"
          index-types="[[esConfig.esType]]"
          pretty-domain="[[prettyDomain]]"
          result-type="[[serverConfig.resultNameSingular]]"
          show="[[openedDatabaseDetail]]"
          timeline-function="[[transforms.entity.timelines]]"
          timestamp-field="[[esConfig.timestamp]]">
        </database-details>
      </styled-dialog>
    </template>

    <styled-dialog id="searchImageGalleryDialog" fill header="Image Gallery of [[serverConfig.resultNamePlural]]">
      <image-gallery
        id="searchImageGallery"
        images="[[imagesFromResults]]"
        new-tab
        small-image-style-class="[[findBlurStyleClass(blurImages)]]"
        large-image-style-class="[[findBlurStyleClass(blurImages, 'large')]]">
      </image-gallery>
    </styled-dialog>

    <search-fields-dialog
      button-callbacks="{{searchFieldsDialogCallbacks}}"
      date-config="[[datePropertiesToKeys]]"
      hide-images="[[!esConfig.showImagesInSearch]]"
      image-upload-url="[[findDigUrl(serverConfig.pathPrefix, 'uploadImage')]]"
      image-url-prefix="[[esConfig.imageUrlPrefix]]"
      image-url-suffix="[[esConfig.imageUrlSuffix]]"
      images="{{imagesUploaded}}"
      images-processing="[[imagesProcessing]]"
      large-image-style-class="[[findBlurStyleClass(blurImages, 'large')]]"
      search-fields-config="[[searchFieldsDialogConfig]]"
      small-image-style-class="[[findBlurStyleClass(blurImages)]]"
      network-expansion-parameters="{{networkExpansionParameters}}"
      process-request="{{processRequest}}"
      search-parameters="{{searchParameters}}">
    </search-fields-dialog>

    <template is="dom-if" if="[[serverConfig.username]]">
      <user-settings-dialog
        button-callbacks="{{userSettingsDialogCallbacks}}"
        enable-email-address
        enable-search
        build-popup-data-function="[[transforms.config.searchTerms]]"
        build-state-data-function="[[transforms.config.searchState]]"
        data-config="[[searchFieldsCollection]]"
        function-config="[[searchFields]]"
        profile-manager="[[profileManager]]"
        reset-dates-data-function="[[createResetDatesFunction(searchFields)]]"
        result-link-function="[[transforms.config.resultLink]]"
        user-id="[[userId]]"
        user-loading="[[userLoading]]"
        username="[[serverConfig.username]]"
        blur-images="{{blurImages}}"
        cases="{{cases}}"
        email-address="{{emailAddress}}"
        network-expansion-parameters="{{networkExpansionParameters}}"
        notifications="{{notifications}}"
        notification-date="{{notificationDate}}"
        notification-interval="{{notificationInterval}}"
        process-request="{{processRequest}}"
        search-parameters="{{searchParameters}}">
      </user-settings-dialog>
    </template>

    <export-dialog
      button-callbacks="{{exportDialogCallbacks}}"
      client="[[esClient]]"
      data="[[searchResultsShown]]"
      export-endpoint="[[findDigUrl(serverConfig.pathPrefix, 'export')]]"
      index-name="[[esConfig.esIndex]]"
      index-types="[[esConfig.esType]]"
      search-fields="[[searchFields]]"
      search-parameters="[[searchParameters]]"
      source-include="[[getSourceIncludes(serverConfig.sendSearchesDirectlyToES, esConfig.timestamp, esConfig.uid)]]"
      transform-csv-function="[[transforms.export.createExportDataForCsv]]"
      transform-pdf-function="[[transforms.export.createExportDataForPdf]]"
      transform-search-input-function="[[transforms.export.createBulkSearchData]]"
      transform-search-results-function="[[transforms.entity.results]]">
    </export-dialog>

    <paper-header-panel class="flex" mode="seamed">
      <paper-toolbar slot="header" id="pageNavbar" class$="[[getNavbarStyleClass(esConfig.showOriginalSearch)]]">
        <div slot="top" class="layout horizontal self-start flex">
          <template is="dom-if" if="[[!esConfig.showOriginalSearch]]">
            <a id="logoLinkBigger" href="[[serverConfig.pathPrefix]]" target="_blank" title="Open a DIG Search Page in a New Tab">
              <img id="logoBigger" src="/dig-ui/dig-logo-bigger.png" alt="">
            </a>

            <search-box 
              date-config="[[datePropertiesToKeys]]"
              network-expansion-parameters="{{networkExpansionParameters}}"
              search-fields-config="[[searchFieldsDialogConfig]]"
              free-text-search-fields="[[freeTextSearchFields]]"
              process-request="{{processRequest}}" 
              search-parameters="{{searchParameters}}">
            </search-box>

            <icon-button bigger id="advancedSearchButton" icon="fa:wrench" on-tap="_toggleSearchDialog" title="Open Advanced Search"></icon-button>
          </template>

          <template is="dom-if" if="[[esConfig.showOriginalSearch]]">
            <a id="logoLink" href="[[serverConfig.pathPrefix]]" target="_blank" title="Open a DIG Search Page in a New Tab">
              <img id="logo" src="/dig-ui/dig-logo.png" alt="">
            </a>

            <search-fields-button
              class="layout vertical center flex"
              style="margin-left: 10px;"
              toggle-dialog-callback="[[searchFieldsDialogCallbacks.toggleDialog]]"
              handle-search-callback="[[searchFieldsDialogCallbacks.handleSearch]]"
              free-text-search-fields="[[freeTextSearchFields]]">
            </search-fields-button>  
          </template>

          <template is="dom-if" if="[[serverConfig.username]]">
            <user-settings-button notifications="[[notifications]]" open-callback="[[userSettingsDialogCallbacks.openSettingsDialog]]"></user-settings-button>
          </template>

          <template is="dom-if" if="[[esConfig]]">
            <icon-button active="[[menuOpened]]" bigger id="menuButton" icon="fa:bars" slot="dropdown-trigger" title-tooltip="More Options" on-tap="toggleMenu"></icon-button>
          </template>
        </div>
      </paper-toolbar>

      <iron-dropdown id="menuDropdown" horizontal-align="right" vertical-align="top" vertical-offset="[[getMenuVerticalOffset(esConfig.showOriginalSearch)]]" opened="{{menuOpened}}">
        <div slot="dropdown-content">
          <template is="dom-if" if="[[serverConfig.username]]">
            <paper-icon-item disabled="[[searchParametersDisabled(searchParameters, searchParameters.*)]]" title="Save Search to Case..." on-tap="openSaveDialog">
              <iron-icon slot="item-icon" icon="fa:floppy-o" item-icon></iron-icon>
              Save Search to Case...
            </paper-icon-item>
          </template>

          <paper-icon-item disabled="[[!hasHistory]]" title="View Your Search History" on-tap="openStateHistoryDialog">
            <iron-icon slot="item-icon" icon="fa:history" item-icon></iron-icon>
            View Your Search History
          </paper-icon-item>

          <template is="dom-if" if="[[!serverConfig.hideBulkSearch]]">
            <paper-icon-item title="Upload a File with Search Terms or Copy & Paste Text" on-tap="openBulkSearchDialog">
              <iron-icon slot="item-icon" icon="fa:upload" item-icon></iron-icon>
              Bulk Search from Uploaded File or Text
            </paper-icon-item>
          </template>

          <template is="dom-if" if="[[esConfig.showImagesInFacets]]">
            <paper-icon-item disabled="[[!imagesFromResults.length]]" title="View the [[serverConfig.resultNamePlural]] in an Image Gallery" on-tap="openSearchImageGallery">
              <iron-icon slot="item-icon" icon="image:photo" item-icon></iron-icon>
              View [[serverConfig.resultNamePlural]] in Image Gallery
            </paper-icon-item>
          </template>

          <template is="dom-if" if="[[serverConfig.tagsListEndpoint]]">
            <paper-icon-item title="View DIG Data Training Options" on-tap="openTagsDialog">
              <iron-icon slot="item-icon" icon="fa:check-circle" item-icon></iron-icon>
              View DIG Data Training Options
            </paper-icon-item>
          </template>

          <template is="dom-if" if="[[!serverConfig.hideDatabaseInfo]]">
            <paper-icon-item title="View the DIG Database Details" on-tap="openDatabaseDetail">
              <iron-icon slot="item-icon" icon="fa:info-circle" item-icon></iron-icon>
              View DIG Database Details
            </paper-icon-item>
          </template>

          <paper-icon-item title="Open a DIG Search Page in a New Tab" on-tap="openNewTab">
            <iron-icon slot="item-icon" icon="fa:external-link-square" item-icon></iron-icon>
            Open a DIG Search Page in a New Tab
          </paper-icon-item>

          <paper-icon-item title="Open DIG Help Page" on-tap="openHelpPage">
            <iron-icon slot="item-icon" icon="fa:question-circle" item-icon></iron-icon>
            Open the DIG Help Page
          </paper-icon-item>

          <paper-icon-item title$="Contact Us ([[serverConfig.supportEmail]])" on-tap="sendSupportEmail">
            <iron-icon slot="item-icon" icon="fa:envelope" item-icon></iron-icon>
            Contact Us
          </paper-icon-item>
        </div>
      </iron-dropdown>

      <template is="dom-if" if="[[esConfig.showOriginalSearch]]">
        <paper-toolbar slot="header" id="searchTermList">
          <!-- TODO FIXME
          <template is="dom-if" if="[[drawerNarrow]]">
            <icon-button
              slot="top"
              id="toggleDrawerButton"
              active="[[drawerOpened]]"
              bigger
              icon="[[getDrawerToggleIcon(drawerOpened)]]"
              title-tooltip="[[getDrawerToggleText(drawerOpened)]]"
              on-tap="toggleDrawer">
            </icon-button>
          </template>
          -->

          <div slot="top" class="layout horizontal">
            <template is="dom-if" if="[[searchParametersDisabled(searchParameters, searchParameters.*)]]">
              <div class="no-facets-text">
                No Search Terms
              </div>
            </template>

            <div class="layout horizontal wrap">
              <template is="dom-repeat" items="[[getNetworkExpansionFields(networkExpansionParameters, searchFields, networkExpansionParameters.*)]]">
                <breadbox-item icon="fa:arrows-alt" icon-text="Network Expansion Active" text="[[item]]"></breadbox-item>
              </template>
              <template is="dom-repeat" items="[[searchKeys]]">
                <selected-facets-display color-map="[[colorMap]]" facet-key="[[item]]" facets="{{searchParameters}}"></selected-facets-display>
              </template>
            </div>
          </div>
        </paper-toolbar>
      </template>

      <!-- Use the display style rather than a dom-if template so the search parameters in the facet panel update. -->
      <paper-drawer-panel
        id="pageDrawer"
        drawer-width="320px"
        narrow="{{drawerNarrow}}"
        responsive-width="640px">

        <div class="layout veritcal" slot="drawer">
          <template is="dom-if" if="[[!serverConfig.sendSearchesDirectlyToES]]">
            <facet-panel id="pageFacets"
              date-fields="[[dateFieldsToProperties]]"
              facets-query="[[facetsQuery]]"
              image-style-class="[[findBlurStyleClass(blurImages)]]"
              network-expansion-parameters="[[networkExpansionParameters]]"
              process-request="{{processRequest}}"
              search-endpoint="[[esConfig.searchEndpoint]]"
              search-keys="[[searchKeys]]"
              search-fields="[[searchFields]]"
              search-parameters="{{searchParameters}}">
            </facet-panel>
          </template>

          <template is="dom-if" if="[[serverConfig.sendSearchesDirectlyToES]]">
            <facet-panel id="pageFacets"
              client="[[esClient]]"
              date-fields="[[dateFieldsToProperties]]"
              image-style-class="[[findBlurStyleClass(blurImages)]]"
              index-name="[[esConfig.esIndex]]"
              index-types="[[esConfig.esType]]"
              network-expansion-parameters="{}"
              process-request="{{processRequest}}"
              query-builder-config="[[searchFieldsCollection]]"
              search-keys="[[searchKeys]]"
              search-fields="[[searchFields]]"
              search-parameters="{{searchParameters}}">
            </facet-panel>
          </template>
        </div>

        <paper-header-panel slot="main" id="pageSearch" mode="seamed">
          <template is="dom-if" if="[[clientConfigLoading]]">
            <loading-spinner class="layout horizontal" show type="Configuration"></loading-spinner>
          </template>

          <template is="dom-if" if="[[esConfig]]">
            <template is="dom-if" if="[[pageWasNotJustOpened]]">
              <paper-material slot="header" id="searchHeader" class="layout horizontal center" elevation="2">
                <div class="search-header-text flex">
                  <template is="dom-if" if="[[!searchError]]">
                    [[searchTitle]]
                  </template>

                  <template is="dom-if" if="[[searchError]]">
                    <elastic-error error="[[searchError]]" message="{{searchErrorMessage}}"></elastic-error>
                    [[searchErrorMessage]]
                  </template>
                </div>

                <div class="layout horizontal center fields-menu">
                  <div>Sort By</div>

                  <dropdown-menu
                    data="[[sortedSearchFields]]"
                    empty-item-title="Relevance"
                    label="Sort By"
                    large
                    no-label-float
                    selected="{{sortKey}}"
                    style="margin-right: 10px;"
                    value-property="key">
                  </dropdown-menu>

                  <aggregation-sort
                    sort-options='[{"title":"Ascending","orderBy":"asc","icon":"fa:sort-amount-asc"},{"title":"Descending","orderBy":"desc","icon":"fa:sort-amount-desc"}]'
                    order-by="{{sortOrder}}">
                  </aggregation-sort>
                </div>

                <div class="layout horizontal center fields-menu">
                  <div>Timeline By</div>

                  <dropdown-menu
                    data="[[dateMenu.fields]]"
                    label="Date"
                    large
                    no-label-float
                    selected="{{dateMenu.selected}}"
                    value-property="field">
                  </dropdown-menu>
                </div>

                <export-button enable="[[searchResultsShown.length]]" open-callback="[[exportDialogCallbacks.openExportDialog]]"></export-button>
              </paper-material>
            </template>

            <template is="dom-if" if="[[!esConfig.hideTimelines]]">
              <template is="dom-if" if="[[shouldShowBarChart(timelineResults.hour)]]">
                <paper-material slot="header" id="searchTimeline" class="layout vertical" elevation="2">
                  <zoomable-bar-chart
                    bar-property="date"
                    data="[[timelineResults.hour.histogram]]"
                    default-color="#212121"
                    default-label="[[serverConfig.resultNamePlural]]"
                    height="85"
                    hide-overview
                    interval="hour"
                    label-property="text"
                    load
                    loading="[[timelineLoading.hour]]"
                    source="[[serverConfig.resultNamePlural]]"
                    stack-property="data"
                    timeline>
                  </zoomable-bar-chart>
                </paper-material>
              </template>

              <template is="dom-if" if="[[shouldShowBarChart(timelineResults.day, timelineResults.hour)]]">
                <paper-material slot="header" id="searchTimeline" class="layout vertical" elevation="2">
                  <zoomable-bar-chart
                    bar-property="date"
                    data="[[timelineResults.day.histogram]]"
                    default-color="#212121"
                    default-label="[[serverConfig.resultNamePlural]]"
                    height="85"
                    hide-overview
                    interval="day"
                    label-property="text"
                    load
                    loading="[[timelineLoading.day]]"
                    source="[[serverConfig.resultNamePlural]]"
                    stack-property="data"
                    timeline>
                  </zoomable-bar-chart>
                </paper-material>
              </template>

              <template is="dom-if" if="[[shouldShowBarChart(timelineResults.week, timelineResults.day)]]">
                <paper-material slot="header" id="searchTimeline" class="layout vertical" elevation="2">
                  <zoomable-bar-chart
                    bar-property="date"
                    data="[[timelineResults.week.histogram]]"
                    default-color="#212121"
                    default-label="[[serverConfig.resultNamePlural]]"
                    height="85"
                    hide-overview
                    interval="week"
                    label-property="text"
                    load
                    loading="[[timelineLoading.week]]"
                    source="[[serverConfig.resultNamePlural]]"
                    stack-property="data"
                    timeline>
                  </zoomable-bar-chart>
                </paper-material>
              </template>

              <template is="dom-if" if="[[shouldShowBarChart(timelineResults.month, timelineResults.week)]]">
                <paper-material slot="header" id="searchTimeline" class="layout vertical" elevation="2">
                  <zoomable-bar-chart
                    bar-property="date"
                    data="[[timelineResults.month.histogram]]"
                    default-color="#212121"
                    default-label="[[serverConfig.resultNamePlural]]"
                    height="85"
                    hide-overview
                    interval="month"
                    label-property="text"
                    load
                    loading="[[timelineLoading.month]]"
                    source="[[serverConfig.resultNamePlural]]"
                    stack-property="data"
                    timeline>
                  </zoomable-bar-chart>
                </paper-material>
              </template>

              <template is="dom-if" if="[[shouldShowBarChart(timelineResults.year, timelineResults.month)]]">
                <paper-material slot="header" id="searchTimeline" class="layout vertical" elevation="2">
                  <zoomable-bar-chart
                    bar-property="date"
                    data="[[timelineResults.year.histogram]]"
                    default-color="#212121"
                    default-label="[[serverConfig.resultNamePlural]]"
                    height="85"
                    hide-overview
                    interval="year"
                    label-property="text"
                    load
                    loading="[[timelineLoading.year]]"
                    source="[[serverConfig.resultNamePlural]]"
                    stack-property="data"
                    timeline>
                  </zoomable-bar-chart>
                </paper-material>
              </template>
            </template>

            <template is="dom-if" if="[[!serverConfig.hideDatabaseInfo]]">
              <template is="dom-if" if="[[!pageWasNotJustOpened]]">
                <database-details
                  client="[[esClient]]"
                  index-name="[[esConfig.esIndex]]"
                  index-types="[[esConfig.esType]]"
                  pretty-domain="[[prettyDomain]]"
                  result-type="[[serverConfig.resultNameSingular]]"
                  show="[[!pageWasNotJustOpened]]"
                  timeline-function="[[transforms.entity.timelines]]"
                  timestamp-field="[[esConfig.timestamp]]">
                </database-details>
              </template>
            </template>

            <result-list
              id="searchResultList"
              new-tab
              text-property="title"
              query-results="[[searchResults]]"
              total-results="[[searchTotal]]"
              shown-results="{{searchResultsShown}}"
              page="{{searchPage}}"
              page-size="10"
              loading="[[searchLoading]]"
              pretty-name="[[serverConfig.resultNamePlural]]"
              pretty-name-singular="[[serverConfig.resultNameSingular]]"
              header="{{searchTitle}}"
              client="[[esClient]]"
              index-name="[[esConfig.esIndex]]"
              index-types="[[esConfig.esType]]"
              id-field="_id"
              search-fields="[[searchFields]]"
              series-data-type="measurement"
              source-include-cached-page='["raw_content"]'
              source-include-nested-data="[[getSourceIncludes(serverConfig.sendSearchesDirectlyToES, esConfig.timestamp, esConfig.uid)]]"
              source-include-series='["knowledge_graph.event_date.key","knowledge_graph.value.key"]'
              transform-cached-page="[[transforms.entity.cache]]"
              transform-nested-data="[[transforms.entity.nestedResults]]"
              transform-series-config='{"dateField":"_source.knowledge_graph.event_date","numberField":"_source.knowledge_graph.value"}'
              transform-series-function="[[transforms.entity.series]]"
              small-image-style-class="[[findBlurStyleClass(blurImages)]]"
              large-image-style-class="[[findBlurStyleClass(blurImages, 'large')]]"
              newline-tag="[[esConfig.newlineTag]]"
              hide-cached-page="[[serverConfig.hideCachedPage]]"
              hide-confidences
              tag-manager="[[tagManager]]">
            </result-list>
          </template>
        </paper-header-panel>
      </paper-drawer-panel>
    </paper-header-panel>
  </template>

  <script>
  (function() {
    'use strict';

    Polymer({
      /* globals _, DigBehaviors */
      is: 'search-page',

      behaviors: [
        DigBehaviors.PageBehavior
      ],

      properties: {
        blurImages: {
          type: Boolean
        },

        cases: {
          type: Array
        },

        clientConfig: {
          type: Object
        },

        clientConfigError: {
          type: Object
        },

        clientConfigFields: {
          type: Object
        },

        clientConfigLoading: {
          type: Boolean,
          value: false
        },

        colorMap: {
          type: Object
        },

        configHeader: {
          computed: 'createAuthHeader(serverConfig)',
          type: Object
        },

        dateFieldsToProperties: {
          type: Object
        },

        dateMenu: {
          type: Object
        },

        datePropertiesToKeys: {
          type: Object
        },

        drawerNarrow: {
          type: Boolean
        },

        drawerOpened: {
          type: Boolean,
          value: false
        },

        domain: {
          computed: 'findDomain(parameters, serverConfig)',
          notify: true,
          type: String
        },

        emailAddress: {
          type: String
        },

        esClient: {
          type: Object
        },

        esConfig: {
          type: Object
        },

        esQuery: {
          type: Object
        },

        esQueryWithoutDates: {
          type: Object
        },

        exportDialogCallbacks: {
          type: Object
        },

        facetsQuery: {
          type: Object
        },

        freeTextSearchFields: {
          type: Array
        },

        hasHistory: {
          type: Boolean
        },

        imagesFromResults: {
          computed: 'findImagesFromResults(searchResultsShown)',
          type: Array
        },

        imagesProcessing: {
          type: Array,
          value: function() {
            return [];
          }
        },

        imagesUploaded: {
          type: Array,
          value: function() {
            return [];
          }
        },

        imageFaceSearchList: {
          type: Array,
          value: function() {
            return [];
          }
        },

        imageFaceSearchLoading: {
          type: Boolean,
          value: false
        },

        imageFaceSearchRunning: {
          type: Boolean,
          value: false
        },

        imageFaceSearchThreshold: {
          type: Number,
          value: 0.1
        },

        imageSimilaritySearchList: {
          type: Array,
          value: function() {
            return [];
          }
        },

        imageSimilaritySearchLoading: {
          type: Boolean,
          value: false
        },

        imageSimilaritySearchRunning: {
          type: Boolean,
          value: false
        },

        imageSimilaritySearchThreshold: {
          type: Number,
          value: 0.3
        },

        logger: {
          type: Object
        },

        logMessage: {
          type: Object
        },

        menuOpened: {
          type: Boolean
        },

        networkExpansionParameters: {
          type: Object
        },

        notifications: {
          type: Boolean
        },

        notificationInterval: {
          type: String
        },

        openedDatabaseDetail: {
          type: Boolean
        },

        pageWasNotJustOpened: {
          computed: 'computePageWasNotJustOpened(searchParameters, searchParameters.*)',
          type: Boolean,
          value: false
        },

        parameters: {
          computed: 'getUrlParameters()',
          type: Object
        },

        prettyDomain: {
          computed: 'findPrettyDomain(domain, serverConfig)',
          notify: true,
          type: String
        },

        processRequest: {
          type: Boolean
        },

        profileManager: {
          type: Object
        },

        searchError: {
          type: Object
        },

        searchErrorMessage: {
          type: String
        },

        searchFields: {
          type: Array
        },

        searchFieldsDialogCallbacks: {
          type: Object
        },

        searchFieldsDialogConfig: {
          type: Object
        },

        searchKeys: {
          type: Array
        },

        searchLoading: {
          notify: true,
          type: Boolean,
          value: false
        },

        searchPage: {
          type: Number
        },

        searchParameters: {
          type: Object
        },

        searchQuery: {
          type: Object
        },

        searchQueryTransformerResults: {
          type: Object
        },

        searchResults: {
          type: Array
        },

        searchResultsShown: {
          type: Array
        },

        searchTitle: {
          type: String
        },

        searchTotal: {
          type: Number
        },

        serverConfig: {
          type: Object
        },

        sortedSearchFields: {
          type: Array
        },

        sortKey: {
          type: String,
          value: ''
        },

        sortOrder: {
          type: String,
          value: 'desc'
        },

        stateHistory: {
          type: Array
        },

        tagManager: {
          type: Object
        },

        timelineAggregation: {
          type: Object,
          value: function() {
            return {};
          }
        },

        timelineError: {
          type: Object,
          value: function() {
            return {};
          }
        },

        timelineLoading: {
          type: Object,
          value: function() {
            return {};
          }
        },

        timelineResults: {
          type: Object,
          value: function() {
            return {};
          }
        },

        transforms: {
          type: Object
        },

        userId: {
          type: String
        },

        userLoading: {
          type: Boolean,
          value: false
        },

        userSettingsDialogCallbacks: {
          type: Object
        }
      },

      observers: [
        'resetTimelineResults(searchParameters, searchParameters.*)',
        'runBothImageSearches(imagesUploaded)'
      ],

      attached: function() {
        this.assignWindowProperties(this);
      },

      /************* PAGE *************/
      buildSearchState: function(config, oldConfig) {
        var state = {};
        _.keys(oldConfig).forEach(function(key) {
          state[key] = config[key] || {};
        });
        return state;
      },

      computePageWasNotJustOpened: function() {
        return this.pageWasNotJustOpened || !this.searchParametersDisabled(this.searchParameters);
      },

      createSearchResultConfig: function(networkExpansionParameters) {
        return {
          isNetworkExpansion: !!(_.findKey(networkExpansionParameters, function(key) {
            return key;
          }))
        };
      },

      createHistogramAggregationConfig: function(interval, dateFieldsToProperties, dateSelected, searchParameters) {
        var config = {
          interval: interval,
          name: this.createHistogramAggregationName(dateFieldsToProperties, dateSelected),
          unidentified: this.serverConfig.resultNamePlural
        };

        if(searchParameters) {
          _.keys(dateFieldsToProperties).forEach(function(dateId) {
            if(dateId === dateSelected) {
              var dateObject = dateFieldsToProperties[dateId];
              var searchObject = searchParameters[dateObject.key];
              config.begin = searchObject[dateObject.start] ? searchObject[dateObject.start].date : undefined;
              config.end = searchObject[dateObject.end] ? searchObject[dateObject.end].date : undefined;
            }
          });
        }

        return config;
      },

      createHistogramAggregationName: function(dateFieldsToProperties, dateSelected) {
        var dateId = _.find(_.keys(dateFieldsToProperties), function(dateId) {
          return dateId === dateSelected;
        });
        return dateId ? dateFieldsToProperties[dateId].key + '_timeline' : undefined;
      },

      createTotalCountFunction: function() {
        return function(response) {
          if(response && response.length && response[0] && response[0].result) {
            if(_.isArray(response[0].result)) {
              return (response[0].result.length && response[0].result[1].hits && response[0].result[1].hits.total ? response[0].result[1].hits.total : 0);
            }
            return (response[0].result.hits && response[0].result.hits.total ? response[0].result.hits.total : 0);
          }
          return 0;
        };
      },

      findImagesFromResults: function(searchResults) {
        var ids = {};
        var images = [];
        searchResults.forEach(function(result) {
          (result.images || []).forEach(function(image) {
            if(!ids[image.id]) {
              images.push(image);
              ids[image.id] = true;
            }
          });
        });
        return images;
      },

      /**
       * Returns the list of active fields in the given network expansion parameters.
       *
       * @param {Object} networkExpansionParameters
       * @param {Array} searchFields
       * @return {Array}
       * @private
       */
      getNetworkExpansionFields: function(networkExpansionParameters, searchFields) {
        if(!networkExpansionParameters) {
          return [];
        }

        return searchFields.reduce(function(networkExpansionFields, searchFieldsObject) {
          if(networkExpansionParameters[searchFieldsObject.key]) {
            networkExpansionFields.push(searchFieldsObject.title);
          }
          return networkExpansionFields;
        }, []);
      },

      getDrawerToggleIcon: function(drawerOpened) {
        return drawerOpened ? 'icons:visibility-off' : 'icons:visibility';
      },

      getDrawerToggleText: function(drawerOpened) {
        return drawerOpened ? 'Showing Facets (Click to Close)' : 'Hiding Facets (Click to Open)';
      },

      getMenuVerticalOffset: function(notBig) {
        return notBig ? 50 : 70;
      },

      getNavbarStyleClass: function(notBig) {
        return notBig ? '' : 'bigger';
      },

      handleImageFaceSearchResults: function(event) {
        if(event.detail.error || event.detail.response.error) {
          while(this.imageFaceSearchList.length && this.imageFaceSearchList[0].face) {
            var inputImage = this.imageFaceSearchList.shift();
            this.handleImageResults('Face', inputImage, [], [], [], this.imageFaceSearchThreshold, (event.detail.error || event.detail.response.error));
          }
        }

        /* jscs:disable requireCamelCaseOrUpperCaseIdentifiers */
        var response = (event.detail.response || {}).AllSimilarFaces || [];
        /* jscs:enable requireCamelCaseOrUpperCaseIdentifiers */
        if(response && response.length) {
          var self = this;
          response.forEach(function(imageResults) {
            /* jscs:disable requireCamelCaseOrUpperCaseIdentifiers */
            var imageUrls = imageResults.SimilarFaces.CachedImageURLs;
            var imageIds = imageResults.SimilarFaces.ImageSha1s;
            var imageDistances = imageResults.SimilarFaces.Distances;
            /* jscs:enable requireCamelCaseOrUpperCaseIdentifiers */

            var inputImage = self.imageFaceSearchList.shift();
            self.handleImageResults('Face', inputImage, imageUrls, imageIds, imageDistances, self.imageFaceSearchThreshold);
          });
        }

        this.runImageFaceSearch();
      },

      handleImageSimilaritySearchResults: function(event) {
        if(event.detail.error || event.detail.response.error) {
          while(this.imageSimilaritySearchList.length && this.imageSimilaritySearchList[0].similarity) {
            var inputImage = this.imageSimilaritySearchList.shift();
            this.handleImageResults('Similarity', inputImage, [], [], [], this.imageSimilaritySearchThreshold, (event.detail.error || event.detail.response.error));
          }
        }

        var response = (event.detail.response || {}).images || [];
        if(response && response.length) {
          var self = this;
          response.forEach(function(imageResults) {
            /* jscs:disable requireCamelCaseOrUpperCaseIdentifiers */
            var imageUrls = imageResults.similar_images.cached_image_urls;
            var imageIds = imageResults.similar_images.sha1;
            var imageDistances = imageResults.similar_images.distance;
            /* jscs:enable requireCamelCaseOrUpperCaseIdentifiers */

            var inputImage = self.imageSimilaritySearchList.shift();
            self.handleImageResults('Similarity', inputImage, imageUrls, imageIds, imageDistances, self.imageSimilaritySearchThreshold);
          });
        }

        this.runImageSimilaritySearch();
      },

      handleImageResults: function(searchType, inputImage, imageUrls, imageIds, imageDistances, imageThreshold, error) {
        var imageIndex = _.findIndex(this.imagesUploaded, function(object) {
          return object.id === inputImage.id;
        });

        if(imageIndex < 0) {
          return;
        }

        var linkFunction = this.transforms && this.transforms.entity ? this.transforms.entity.entityPageLinkForImageId : null;

        // Remove images with distances over the threshold.
        var sliceIndex = _.findIndex(imageDistances, function(distance) {
          return _.toNumber(distance) > imageThreshold;
        });

        var previousImageResults = this.imagesUploaded[imageIndex].hits || [];
        var imageResults = imageIds.map(function(id, index) {
          return {
            id: id,
            link: (linkFunction ? linkFunction(id) : ''),
            rank: imageDistances[index],
            source: imageUrls[index]
          };
        }).slice(0, sliceIndex < 0 ? imageIds.length : sliceIndex);

        // Mark one search as done.
        this.imagesUploaded[imageIndex].searches = this.imagesUploaded[imageIndex].searches - 1;
        if(!this.imagesUploaded[imageIndex].searches) {
          this.set('imagesProcessing', this.imagesProcessing.map(function(id) {
            return id;
          }).filter(function(id) {
            return id !== inputImage.id;
          }));
        }

        var allResults = (!previousImageResults.length ? imageResults : _.uniqBy(previousImageResults.concat(imageResults).sort(function(a, b) {
          return a.rank - b.rank;
        }), 'id')).map(function(result, index) {
          result.name = 'Match #' + (index + 1) + ' (' + inputImage.id + ')';
          return result;
        });

        this.set(['imagesUploaded', imageIndex, 'hits'], allResults);

        if(error && this.logger) {
          this.logger.log('ImageSearch' + searchType + '-Error', '{"type":"' + inputImage.type + '","name":"' + inputImage.id + '"}');
        }
      },

      /**
       * Returns a logical OR of the arguments.
       *
       * @return {Boolean}
       */
      logicalOr: function() {
        var result = false;
        _.each(arguments, function(argument) {
          result = result || argument;
        });
        return !!result;
      },

      openBulkSearchDialog: function() {
        this.$$('#menuDropdown').close();
        this.$$('#bulkSearchDialog').open();
      },

      openDatabaseDetail: function() {
        this.$$('#menuDropdown').close();
        this.$$('#databaseDetailDialog').open();
      },

      openSearchImageGallery: function() {
        this.$$('#menuDropdown').close();
        this.$$('#searchImageGalleryDialog').open();
      },

      /**
       * Resets all the timeline results.
       */
      resetTimelineResults: function() {
        this.set('processRequest', false);
        this.set('timelineResults', {});
        this.set('esQueryWithoutDates', null);
        this.set('processRequest', true);
      },

      runBothImageSearches: function() {
        if(!this.imagesUploaded.length) {
          return;
        }

        // Find all of the new images using their names as unique identifiers.
        var self = this;
        var images = this.imagesUploaded.filter(function(object) {
          var search = _.isUndefined(object.hits);
          object.hits = object.hits || null;
          object.searches = object.searches >= 0 ? object.searches : 2;
          return search;
        });

        self.set('imagesProcessing', this.imagesProcessing.concat(images.map(function(object) {
          return object.id;
        })));

        // Use the map function to create new arrays (same objects though).
        this.set('imageFaceSearchList', this.imageFaceSearchList.concat(images.map(function(object) {
          return object;
        })));
        this.set('imageSimilaritySearchList', this.imageSimilaritySearchList.concat(images.map(function(object) {
          return object;
        })));

        // Run the face and similarity searches simultaneously.
        if(!this.imageFaceSearchRunning) {
          this.runImageFaceSearch();
        }
        if(!this.imageSimilaritySearchRunning) {
          this.runImageSimilaritySearch();
        }
      },

      runImageFaceSearch: function() {
        if(!this.imageFaceSearchList.length) {
          this.imageFaceSearchRunning = false;
          return;
        }

        this.imageFaceSearchRunning = true;
        this.sendImageSearchRequest('Face', 'imageFaceSearch', this.imageFaceSearchList, this.imageFaceSearchThreshold);
      },

      runImageSimilaritySearch: function() {
        if(!this.imageSimilaritySearchList.length) {
          this.imageSimilaritySearchRunning = false;
          return;
        }

        this.imageSimilaritySearchRunning = true;
        this.sendImageSearchRequest('Similarity', 'imageSimilaritySearch', this.imageSimilaritySearchList, this.imageSimilaritySearchThreshold);
      },

      /**
       * Returns whether all the terms in the given search parameters object are disabled.
       *
       * @param {Object} searchParameters
       * @return {Boolean}
       */
      searchParametersDisabled: function(searchParameters) {
        return _.keys(searchParameters).every(function(type) {
          return _.keys(searchParameters[type]).every(function(term) {
            return !searchParameters[type][term].enabled;
          });
        });
      },

      sendImageSearchRequest: function(searchType, searchName, searchList, imageThreshold) {
        // Run in batches of 5.  All 5 must be either links or uploaded files.
        var dataType = searchList[0].type;
        var objectList = searchList.filter(function(object) {
          return object.type === dataType;
        }).slice(0, 5);
        var sourceList = objectList.map(function(object) {
          // Set the 'face' or 'similarity' property to 'true' for the objects in the search.
          object[searchType.toLowerCase()] = true;
          if(dataType === 'DATA') {
            return object.source.substring(object.source.indexOf(';base64,') + 8);
          }
          return object.source;
        });

        var authConfig = (this.serverConfig.imageServiceConfig.auth || {});
        var auth = authConfig.user && authConfig.password ? 'Basic ' + btoa(authConfig.user + ':' + authConfig.password) : '';
        var endpointConfig = (this.serverConfig.imageServiceConfig.endpoint || {});
        var endpoint = endpointConfig[dataType.toLowerCase()];
        var hostConfig = (this.serverConfig.imageServiceConfig.host || {});
        var host = hostConfig[searchType.toLowerCase()];

        if(this.logger) {
          var logMessage = '["' + objectList.map(function(object) {
            return object.id;
          }).join('","') + '"]';
          this.logger.log('ImageSearch' + searchType + '-Start', logMessage);
        }

        if(auth && endpoint && host) {
          var requestElement = this.$$('#' + searchName);
          requestElement.body = {
            data: sourceList.join(',')
          };
          requestElement.body.options = '{' + '"max_returned":1000,"near_dup":1,"near_dup_th":' + imageThreshold + '}';
          requestElement.url = host + endpoint;
          requestElement.headers = requestElement.headers || {};
          requestElement.headers.Authorization = auth;
          requestElement.generateRequest();
        }
      },

      /**
       * Returns whether to reduce the interval for the given results.
       *
       * @param {Object} results
       * @return {Boolean}
       */
      shouldReduceInterval: function(results) {
        if(!results || !results.histogram.length) {
          return false;
        }
        return results.histogram.length <= 60;
      },

      /**
       * Returns whether to show the bar chart for the given results.
       *
       * @param {Object} requiredResults
       * @param {Object} overrideResults
       * @return {Boolean}
       */
      shouldShowBarChart: function(requiredResults, overrideResults) {
        if(!requiredResults || !requiredResults.histogram.length || (overrideResults && overrideResults.histogram.length)) {
          return false;
        }
        return requiredResults.histogram.length > 1;
      },

      toggleDrawer: function() {
        this.drawerOpened = !this.drawerOpened;
        this.$$('#pageDrawer').togglePanel();
      },

      validateImageServiceConfig: function(config) {
        return !!(config && config.auth && config.auth.user && config.auth.password && config.endpoint && config.endpoint.data && config.endpoint.link && config.host && config.host.face && config.host.similarity);
      },

      _toggleSearchDialog: function() {
        this.searchFieldsDialogCallbacks.toggleDialog();
      }
    });
  })();
  </script>
</dom-module>
